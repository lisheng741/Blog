(window.webpackJsonp=window.webpackJsonp||[]).push([[27],{436:function(t,s,a){"use strict";a.r(s);var n=a(56),e=Object(n.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"ef-core-的-code-first-模式"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ef-core-的-code-first-模式"}},[t._v("#")]),t._v(" EF Core 的 Code First 模式")]),t._v(" "),a("p"),a("div",{staticClass:"table-of-contents"},[a("ul",[a("li",[a("a",{attrs:{href:"#_0-前言"}},[t._v("0 前言")])]),a("li",[a("a",{attrs:{href:"#_1-相关介绍"}},[t._v("1 相关介绍")]),a("ul",[a("li",[a("a",{attrs:{href:"#_1-1-code-first-模式"}},[t._v("1.1 Code First 模式")])]),a("li",[a("a",{attrs:{href:"#_1-2-相关名词"}},[t._v("1.2 相关名词")])])])]),a("li",[a("a",{attrs:{href:"#_2-ef-core-的基础使用"}},[t._v("2 EF Core 的基础使用")]),a("ul",[a("li",[a("a",{attrs:{href:"#_2-1-新建-webapi-工程"}},[t._v("2.1 新建 WebApi 工程")])]),a("li",[a("a",{attrs:{href:"#_2-2-引入-ef-core-相关-nuget-包"}},[t._v("2.2 引入 EF Core 相关 Nuget 包")])]),a("li",[a("a",{attrs:{href:"#_2-3-准备配置信息"}},[t._v("2.3 准备配置信息")])]),a("li",[a("a",{attrs:{href:"#_2-4-新建数据库上下文-dbcontext"}},[t._v("2.4 新建数据库上下文 DbContext")])]),a("li",[a("a",{attrs:{href:"#_2-5-创建数据实体"}},[t._v("2.5 创建数据实体")])]),a("li",[a("a",{attrs:{href:"#_2-6-注册服务"}},[t._v("2.6 注册服务")])]),a("li",[a("a",{attrs:{href:"#_2-7-编译项目"}},[t._v("2.7 编译项目")])]),a("li",[a("a",{attrs:{href:"#_2-8-数据库迁移-code-first-模式"}},[t._v("2.8 数据库迁移（Code First 模式）")])]),a("li",[a("a",{attrs:{href:"#_2-9-增加测试控制器"}},[t._v("2.9 增加测试控制器")])]),a("li",[a("a",{attrs:{href:"#_2-10-运行项目"}},[t._v("2.10 运行项目")])]),a("li",[a("a",{attrs:{href:"#_2-11-源码"}},[t._v("2.11 源码")])])])]),a("li",[a("a",{attrs:{href:"#_3-数据库迁移"}},[t._v("3 数据库迁移")]),a("ul",[a("li",[a("a",{attrs:{href:"#_3-1-安装工具"}},[t._v("3.1 安装工具")])]),a("li",[a("a",{attrs:{href:"#_3-2-迁移"}},[t._v("3.2 迁移")])])])]),a("li",[a("a",{attrs:{href:"#_4-其他操作"}},[t._v("4 其他操作")]),a("ul",[a("li",[a("a",{attrs:{href:"#_4-1-迁移代码添加-sql"}},[t._v("4.1 迁移代码添加 SQL")])]),a("li",[a("a",{attrs:{href:"#_4-2-自定义迁移操作"}},[t._v("4.2 自定义迁移操作")])]),a("li",[a("a",{attrs:{href:"#创建和删除-api-ensurecreated-和-ensuredeleted"}},[t._v("创建和删除 API（EnsureCreated 和 EnsureDeleted）")])])])]),a("li",[a("a",{attrs:{href:"#_5-code-first-模式常见问题"}},[t._v("5 Code First 模式常见问题")]),a("ul",[a("li",[a("a",{attrs:{href:"#_5-1-列重命名"}},[t._v("5.1 列重命名")])])])]),a("li",[a("a",{attrs:{href:"#参考来源"}},[t._v("参考来源")])])])]),a("p"),t._v(" "),a("h2",{attrs:{id:"_0-前言"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_0-前言"}},[t._v("#")]),t._v(" 0 前言")]),t._v(" "),a("p",[t._v("本文正文第一节，会对 Code First 进行基本的介绍，以及对相关名词进行说明，读者一开始可以不用在这里消耗过多时间，可以先操作一遍例子，再回过头理解。")]),t._v(" "),a("p",[t._v("第二节，以一个简单的例子，展示 EF Core 的 Code First 模式的操作流程。")]),t._v(" "),a("p",[t._v("第三节，将 Code First 的其他指令例举出来，以便于日后翻查。")]),t._v(" "),a("p",[t._v("第四节（未完成），将 Code First 其他一些操作，如：在迁移代码中添加 SQL 语句等。")]),t._v(" "),a("p",[t._v("第五节，将 Code First 模式常见的问题列举出来，防止踩坑。")]),t._v(" "),a("h2",{attrs:{id:"_1-相关介绍"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-相关介绍"}},[t._v("#")]),t._v(" 1 相关介绍")]),t._v(" "),a("h3",{attrs:{id:"_1-1-code-first-模式"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-code-first-模式"}},[t._v("#")]),t._v(" 1.1 Code First 模式")]),t._v(" "),a("p",[t._v("以 EF Core 模型为准，使用"),a("a",{attrs:{href:"https://docs.microsoft.com/zh-cn/ef/core/managing-schemas/migrations/",target:"_blank",rel:"noopener noreferrer"}},[t._v("迁移"),a("OutboundLink")],1),t._v("的方式，将 EF Core 模型的变化以增量的方式更新到数据库。")]),t._v(" "),a("p",[t._v("简单理解：以C#代码定义的数据实体，生成数据库的表结构。")]),t._v(" "),a("h3",{attrs:{id:"_1-2-相关名词"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-相关名词"}},[t._v("#")]),t._v(" 1.2 相关名词")]),t._v(" "),a("p",[a("strong",[t._v("数据库上下文（DbContext）")]),t._v("：继承自 DbContext，主要作用是连接数据库，跟踪数据实体状态（实体状态包括：added、modified、deleted 等），将数据库实体的状态写入数据库（持久化至数据库中）。")]),t._v(" "),a("p",[a("strong",[t._v("数据实体（Entity）")]),t._v("：C#的实体类，与数据库的表对应")]),t._v(" "),a("p",[a("strong",[t._v("数据模型（Model）")]),t._v("：EF Core 数据模型，与数据库架构对应。")]),t._v(" "),a("p",[a("strong",[t._v("约定（conventions）")]),t._v("：主要是数据实体的类名、属性。")]),t._v(" "),a("p",[a("strong",[t._v("数据注释（data annotations）")]),t._v("：应用于类上、属性的特性（如："),a("code",[t._v('[Table("SysUser")]')]),t._v("），会被 Fluent API 的配置覆盖。")]),t._v(" "),a("p",[a("strong",[t._v("Fluent API")]),t._v("：于自定义的 DbContext 中重写 OnModelCreating 方法中，对数据模型描述的配置，如：")]),t._v(" "),a("div",{staticClass:"language-csharp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-csharp"}},[a("code",[t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("protected")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("override")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token return-type class-name"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")])]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("OnModelCreating")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ModelBuilder")]),t._v(" modelBuilder"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n     builder"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token generic-method"}},[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Entity")]),a("span",{pre:!0,attrs:{class:"token generic class-name"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("User"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("ToTable")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"SysUser"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[a("strong",[t._v("数据实体（Entity）、数据模型（Model）、约定（conventions）、数据注释（data annotations）、Fluent API 说明：")])]),t._v(" "),a("p",[t._v("数据实体（Entity）的类名、属性等，称之为约定（conventions），约定主要是为了定义数据模型（Model）的形状。")]),t._v(" "),a("p",[t._v("但是光靠约定可能不足以完整描述数据模型，有时我们的数据模型与我们的数据实体可能也有差异，这时，就可以通过数据注释（data annotations）和 Fluent API 补充。")]),t._v(" "),a("h2",{attrs:{id:"_2-ef-core-的基础使用"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-ef-core-的基础使用"}},[t._v("#")]),t._v(" 2 EF Core 的基础使用")]),t._v(" "),a("h3",{attrs:{id:"_2-1-新建-webapi-工程"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-新建-webapi-工程"}},[t._v("#")]),t._v(" 2.1 新建 WebApi 工程")]),t._v(" "),a("p",[t._v("这里基于 VS Code 工具，使用命令行创建一个 WebApi 程序：")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("mkdir")]),t._v(" CodeFirstTest "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("cd")]),t._v(" CodeFirstTest "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#新建文件夹DbFirstTest并切换至该目录下")]),t._v("\ndotnet new webapi --framework net6.0   "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#新建ASP.NET6.0 WebAPI程序")]),t._v("\n")])])]),a("h3",{attrs:{id:"_2-2-引入-ef-core-相关-nuget-包"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-引入-ef-core-相关-nuget-包"}},[t._v("#")]),t._v(" 2.2 引入 EF Core 相关 Nuget 包")]),t._v(" "),a("p",[t._v("EF Core 部分 Nuget 包如下：")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("Microsoft.EntityFrameworkCore --"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">>")]),t._v(" 核心包\nMicrosoft.EntityFrameworkCore.Design --"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">>")]),t._v(" Design包：Code First 或 Db First 需要\nMicrosoft.EntityFrameworkCore.SqlServer --"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">>")]),t._v(" 微软官方 SQL Server 驱动\nPomelo.EntityFrameworkCore.MySql --"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">>")]),t._v(" 社区 MySql 驱动\nMySql.EntityFrameworkCore --"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">>")]),t._v(" Oracle官方 MySql 驱动\n")])])]),a("p",[t._v("其中核心包是必须的，另外还需配备对应数据库的驱动包，而 Design 包主要是在使用 Code First 或 Db First 需要的包。")]),t._v(" "),a("p",[t._v("这里，我们向工程引入必须的 Nuget 包，SQL 驱动程序选择 SQL Server 的：")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("dotnet "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("add")]),t._v(" package Microsoft.EntityFrameworkCore --version "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("6.0")]),t._v(".4\ndotnet "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("add")]),t._v(" package Microsoft.EntityFrameworkCore.Design --version "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("6.0")]),t._v(".4\ndotnet "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("add")]),t._v(" package Microsoft.EntityFrameworkCore.SqlServer --version "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("6.0")]),t._v(".4\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# dotnet add package Pomelo.EntityFrameworkCore.MySql --version 6.0.1")]),t._v("\n")])])]),a("h3",{attrs:{id:"_2-3-准备配置信息"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-准备配置信息"}},[t._v("#")]),t._v(" 2.3 准备配置信息")]),t._v(" "),a("p",[t._v("在 appsettings.json 中增加一个节点，用于连接数据库时使用。")]),t._v(" "),a("div",{staticClass:"language-json extra-class"},[a("pre",{pre:!0,attrs:{class:"language-json"}},[a("code",[a("span",{pre:!0,attrs:{class:"token property"}},[t._v('"ConnectionStrings"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token property"}},[t._v('"SqlServer"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"server=localhost;database=efcore;uid=sa;pwd=Qwe123456;"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token property"}},[t._v('"MySql"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"server=localhost;port=3306;database=efcore;user=root;password=123456;charset=utf8mb4;"')]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("h3",{attrs:{id:"_2-4-新建数据库上下文-dbcontext"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-4-新建数据库上下文-dbcontext"}},[t._v("#")]),t._v(" 2.4 新建数据库上下文 DbContext")]),t._v(" "),a("p",[t._v("新建一个自定义的数据库上下文 TestDbContext：")]),t._v(" "),a("div",{staticClass:"language-csharp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-csharp"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("using")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("Microsoft"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("EntityFrameworkCore")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("namespace")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("CodeFirstTest")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("TestContext")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token type-list"}},[a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("DbContext")])]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("TestContext")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("DbContextOptions"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("TestContext"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v(" options"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("base")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("options"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("protected")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("override")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token return-type class-name"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")])]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("OnConfiguring")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("DbContextOptionsBuilder")]),t._v(" options"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("base")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("OnConfiguring")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("options"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("protected")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("override")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token return-type class-name"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")])]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("OnModelCreating")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ModelBuilder")]),t._v(" builder"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        builder"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token generic-method"}},[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Entity")]),a("span",{pre:!0,attrs:{class:"token generic class-name"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("User"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("base")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("OnModelCreating")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("builder"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("virtual")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token return-type class-name"}},[t._v("DbSet"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("User"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v(" User "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("get")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("set")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("h3",{attrs:{id:"_2-5-创建数据实体"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-5-创建数据实体"}},[t._v("#")]),t._v(" 2.5 创建数据实体")]),t._v(" "),a("p",[t._v("创建一个数据实体 User 如下：")]),t._v(" "),a("div",{staticClass:"language-csharp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-csharp"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("using")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("System"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("ComponentModel"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("DataAnnotations")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("using")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("System"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("ComponentModel"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("DataAnnotations"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Schema")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("using")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("Microsoft"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("EntityFrameworkCore")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("namespace")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("CodeFirstTest")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token attribute"}},[a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Table")]),a("span",{pre:!0,attrs:{class:"token attribute-arguments"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"SysUser"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")])])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("User")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token attribute"}},[a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Key")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token return-type class-name"}},[t._v("Guid")]),t._v(" Id "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("get")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("set")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token constructor-invocation class-name"}},[t._v("Guid")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token attribute"}},[a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("StringLength")]),a("span",{pre:!0,attrs:{class:"token attribute-arguments"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("128")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")])])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token attribute"}},[a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Comment")]),a("span",{pre:!0,attrs:{class:"token attribute-arguments"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"姓名"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")])])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token return-type class-name"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("string")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("?")])]),t._v(" Name "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("get")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("set")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token attribute"}},[a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("StringLength")]),a("span",{pre:!0,attrs:{class:"token attribute-arguments"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("11")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")])])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token attribute"}},[a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Comment")]),a("span",{pre:!0,attrs:{class:"token attribute-arguments"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"手机号码"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")])])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token return-type class-name"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("string")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("?")])]),t._v(" Phone "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("get")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("set")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[a("code",[t._v('[Table("SysUser")]')]),t._v(" 注释数据库中的表名为 SysUser。")]),t._v(" "),a("p",[a("code",[t._v("[StringLength(128)]")]),t._v(" 注释字符串长度，"),a("code",[t._v('[Comment("姓名")]')]),t._v(" 注释数据库中该字段含义。")]),t._v(" "),a("p",[t._v("这些注释，称为“数据注释”，主要是对数据模型的补充描述（可以简单认为：对数据库的表结构的补充描述）。")]),t._v(" "),a("p",[t._v("关于配置数据模型的详细内容，可以翻查"),a("a",{attrs:{href:"https://docs.microsoft.com/zh-cn/ef/core/modeling/",target:"_blank",rel:"noopener noreferrer"}},[t._v("EF Core官方文档：创建并配置模型"),a("OutboundLink")],1),t._v("。")]),t._v(" "),a("h3",{attrs:{id:"_2-6-注册服务"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-6-注册服务"}},[t._v("#")]),t._v(" 2.6 注册服务")]),t._v(" "),a("p",[t._v("在 Program.cs 中注册服务，并配置数据库连接串。")]),t._v(" "),a("div",{staticClass:"language-csharp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-csharp"}},[a("code",[a("span",{pre:!0,attrs:{class:"token class-name"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")])]),t._v(" configuration "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" builder"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Configuration"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nbuilder"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Services"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token generic-method"}},[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("AddDbContext")]),a("span",{pre:!0,attrs:{class:"token generic class-name"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("TestContext"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("options "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    options"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("UseSqlServer")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("configuration"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"ConnectionStrings:SqlServer"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("h3",{attrs:{id:"_2-7-编译项目"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-7-编译项目"}},[t._v("#")]),t._v(" 2.7 编译项目")]),t._v(" "),a("p",[t._v("在生成迁移之前，需要先对工程进行编译，否则会报错。")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("dotnet build\n")])])]),a("h3",{attrs:{id:"_2-8-数据库迁移-code-first-模式"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-8-数据库迁移-code-first-模式"}},[t._v("#")]),t._v(" 2.8 数据库迁移（Code First 模式）")]),t._v(" "),a("p",[t._v("如果没有安装 EF 工具，需要先安装")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 安装全局工具")]),t._v("\ndotnet tool "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" --global dotnet-ef\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 更新工具")]),t._v("\ndotnet tool update --global dotnet-ef\n")])])]),a("p",[t._v("创建一个名为 Initial 的迁移，将会在项目根目录下生成一个 Migrations 的目录：")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("dotnet ef migrations "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("add")]),t._v(" Initial\n")])])]),a("p",[t._v("更新到数据库")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("dotnet ef database update\n")])])]),a("h3",{attrs:{id:"_2-9-增加测试控制器"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-9-增加测试控制器"}},[t._v("#")]),t._v(" 2.9 增加测试控制器")]),t._v(" "),a("p",[t._v("增加一个 UserController 用于测试。")]),t._v(" "),a("div",{staticClass:"language-csharp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-csharp"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("using")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("Microsoft"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("AspNetCore"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Mvc")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("namespace")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("CodeFirstTest"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Controllers")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token attribute"}},[a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ApiController")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token attribute"}},[a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Route")]),a("span",{pre:!0,attrs:{class:"token attribute-arguments"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"[controller]"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")])])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("UserController")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token type-list"}},[a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ControllerBase")])]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("private")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("readonly")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("TestContext")]),t._v(" _db"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("UserController")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("TestContext")]),t._v(" db"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        _db "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" db"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token attribute"}},[a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("HttpGet")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token return-type class-name"}},[t._v("User"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("?")])]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Get")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Guid")]),t._v(" id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" _db"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("User"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Find")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token attribute"}},[a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("HttpPost")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token return-type class-name"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")])]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Post")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("User")]),t._v(" user"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        _db"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("User"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Add")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("user"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        _db"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("SaveChanges")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token attribute"}},[a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("HttpDelete")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token return-type class-name"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("bool")])]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Delete")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Guid")]),t._v(" id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("User"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("?")])]),t._v(" user "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" _db"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("User"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Find")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("??")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("user "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        _db"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("User"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Remove")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("user"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        _db"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("SaveChanges")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("h3",{attrs:{id:"_2-10-运行项目"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-10-运行项目"}},[t._v("#")]),t._v(" 2.10 运行项目")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("dotnet build\ndotnet run\n")])])]),a("p",[t._v("访问：https://localhost:7232/swagger/index.html")]),t._v(" "),a("p",[t._v("对接口进行操作，可以实现对 User 的增删查。")]),t._v(" "),a("h3",{attrs:{id:"_2-11-源码"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-11-源码"}},[t._v("#")]),t._v(" 2.11 源码")]),t._v(" "),a("p",[t._v("Gitee：https://gitee.com/lisheng741/testnetcore/tree/master/EFCore/CodeFirstTest")]),t._v(" "),a("p",[t._v("Github：https://github.com/lisheng741/testnetcore/tree/master/EFCore/CodeFirstTest")]),t._v(" "),a("h2",{attrs:{id:"_3-数据库迁移"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-数据库迁移"}},[t._v("#")]),t._v(" 3 数据库迁移")]),t._v(" "),a("p",[t._v("具体参考"),a("a",{attrs:{href:"https://docs.microsoft.com/zh-cn/ef/core/managing-schemas/migrations/?tabs=dotnet-core-cli",target:"_blank",rel:"noopener noreferrer"}},[t._v("EF Core官方文档：管理数据库架构：迁移"),a("OutboundLink")],1),t._v("。")]),t._v(" "),a("h3",{attrs:{id:"_3-1-安装工具"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-安装工具"}},[t._v("#")]),t._v(" 3.1 安装工具")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 安装全局工具")]),t._v("\ndotnet tool "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" --global dotnet-ef\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 更新工具")]),t._v("\ndotnet tool update --global dotnet-ef\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 验证安装")]),t._v("\ndotnet ef\n")])])]),a("h3",{attrs:{id:"_3-2-迁移"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-迁移"}},[t._v("#")]),t._v(" 3.2 迁移")]),t._v(" "),a("h4",{attrs:{id:"_3-2-1-管理迁移"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-1-管理迁移"}},[t._v("#")]),t._v(" 3.2.1 管理迁移")]),t._v(" "),a("p",[t._v("创建一个名为 Migrations 的目录，并生成一些文件")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("dotnet ef migrations "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("add")]),t._v(" InitialCreate\n")])])]),a("p",[t._v("创建迁移时指定迁移目录")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("dotnet ef migrations "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("add")]),t._v(" InitialCreate --output-dir "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("directory"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n")])])]),a("p",[t._v("删除迁移")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("dotnet ef migrations remove\n")])])]),a("p",[t._v("列出所有迁移")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("dotnet ef migrations list\n")])])]),a("h4",{attrs:{id:"_3-2-2-应用迁移"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-2-应用迁移"}},[t._v("#")]),t._v(" 3.2.2 应用迁移")]),t._v(" "),a("p",[t._v("应用迁移主要有2种方式，一种是生成 SQL 脚本，一种是通过命令行工具执行命令进行迁移，具体请参考"),a("a",{attrs:{href:"https://docs.microsoft.com/zh-cn/ef/core/managing-schemas/migrations/applying?tabs=dotnet-core-cli",target:"_blank",rel:"noopener noreferrer"}},[t._v("EF Core 官方文档：应用迁移"),a("OutboundLink")],1),t._v("。")]),t._v(" "),a("p",[t._v("除了这两种迁移方式外，还有一种是在程序种迁移，即将迁移的代码写入程序中，由程序运行时触发。")]),t._v(" "),a("h5",{attrs:{id:"_1-命令行工具"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-命令行工具"}},[t._v("#")]),t._v(" 1) 命令行工具")]),t._v(" "),a("p",[t._v("将迁移应用到数据库")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("dotnet ef database update\n")])])]),a("p",[t._v("将迁移应用到数据库：指定迁移")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("dotnet ef database update AddNewTables\n")])])]),a("p",[t._v("注意：使用该命令，也可以进行迁移回滚（回滚到之前的某个迁移）。")]),t._v(" "),a("h5",{attrs:{id:"_2-生成-sql-脚本"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-生成-sql-脚本"}},[t._v("#")]),t._v(" 2) 生成 SQL 脚本")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("dotnet ef migrations script\n")])])]),a("p",[t._v("指定迁移起点（From）")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("dotnet ef migrations script AddNewTables\n")])])]),a("p",[t._v("指定迁移起点（From）和结束点（To）")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("dotnet ef migrations script AddNewTables AddAuditTable\n")])])]),a("p",[t._v("幂等 SQL 脚本（idempotent）：脚本将在内部检查已经应用哪些迁移（通过迁移历史记录表），并且只应用缺少的迁移。")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("dotnet ef migrations script --idempotent\n")])])]),a("h5",{attrs:{id:"_3-在程序运行时进行迁移"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-在程序运行时进行迁移"}},[t._v("#")]),t._v(" 3）在程序运行时进行迁移")]),t._v(" "),a("p",[t._v("请参考"),a("a",{attrs:{href:"https://docs.microsoft.com/zh-cn/ef/core/managing-schemas/migrations/applying?tabs=dotnet-core-cli#apply-migrations-at-runtime",target:"_blank",rel:"noopener noreferrer"}},[t._v("EF Core 文档：应用迁移：在运行时应用迁移"),a("OutboundLink")],1)]),t._v(" "),a("h2",{attrs:{id:"_4-其他操作"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-其他操作"}},[t._v("#")]),t._v(" 4 其他操作")]),t._v(" "),a("h3",{attrs:{id:"_4-1-迁移代码添加-sql"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-迁移代码添加-sql"}},[t._v("#")]),t._v(" 4.1 迁移代码添加 SQL")]),t._v(" "),a("p",[t._v("请参考："),a("a",{attrs:{href:"https://docs.microsoft.com/zh-cn/ef/core/managing-schemas/migrations/managing?tabs=dotnet-core-cli#adding-raw-sql",target:"_blank",rel:"noopener noreferrer"}},[t._v("EF Core 官方文档：管理迁移：添加原始 SQL"),a("OutboundLink")],1)]),t._v(" "),a("p",[t._v("下面的例子，用一个新的 "),a("code",[t._v("FullName")]),t._v(" 属性替换现有的 "),a("code",[t._v("FirstName")]),t._v(" 和 "),a("code",[t._v("LastName")]),t._v(" 属性，并将现存的数据转移到新的列上。")]),t._v(" "),a("div",{staticClass:"language-csharp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-csharp"}},[a("code",[t._v("migrationBuilder"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token generic-method"}},[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("AddColumn")]),a("span",{pre:!0,attrs:{class:"token generic class-name"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("string")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token named-parameter punctuation"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"FullName"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token named-parameter punctuation"}},[t._v("table")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Customer"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token named-parameter punctuation"}},[t._v("nullable")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\nmigrationBuilder"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Sql")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("\"UPDATE Customer SET FullName = FirstName + ' ' + LastName;\"")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\nmigrationBuilder"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("DropColumn")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token named-parameter punctuation"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"FirstName"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token named-parameter punctuation"}},[t._v("table")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Customer"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\nmigrationBuilder"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("DropColumn")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token named-parameter punctuation"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"LastName"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token named-parameter punctuation"}},[t._v("table")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Customer"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("h3",{attrs:{id:"_4-2-自定义迁移操作"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-自定义迁移操作"}},[t._v("#")]),t._v(" 4.2 自定义迁移操作")]),t._v(" "),a("p",[t._v("MigrationBuilder.Sql() 或 自定义 MigrationOperation 对象，可以对 MigrationBuilder 进行扩展。")]),t._v(" "),a("p",[t._v("如：想要在迁移代码中使用如下代码（CreateUser 方法为自定义方法）")]),t._v(" "),a("div",{staticClass:"language-csharp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-csharp"}},[a("code",[t._v("migrationBuilder"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("CreateUser")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"SQLUser1"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Password"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("h4",{attrs:{id:"_4-2-1-使用-migrationbuilder-sql"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-1-使用-migrationbuilder-sql"}},[t._v("#")]),t._v(" 4.2.1 使用 MigrationBuilder.Sql()")]),t._v(" "),a("p",[t._v("CreateUser 自定义代码如下：")]),t._v(" "),a("div",{staticClass:"language-csharp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-csharp"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token return-type class-name"}},[t._v("OperationBuilder"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("SqlOperation"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("CreateUser")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("MigrationBuilder")]),t._v(" migrationBuilder"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("string")])]),t._v(" name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("string")])]),t._v(" password"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" migrationBuilder"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Sql")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token interpolation-string"}},[a("span",{pre:!0,attrs:{class:"token string"}},[t._v('$"CREATE USER ')]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token expression language-csharp"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")])]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v(" WITH PASSWORD '")]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token expression language-csharp"}},[t._v("password")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")])]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("';\"")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("h4",{attrs:{id:"_4-2-2-自定义-migrationoperation-对象"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-2-自定义-migrationoperation-对象"}},[t._v("#")]),t._v(" 4.2.2 自定义 MigrationOperation 对象")]),t._v(" "),a("p",[t._v("请参考"),a("a",{attrs:{href:"https://docs.microsoft.com/zh-cn/ef/core/managing-schemas/migrations/operations#using-a-migrationoperation",target:"_blank",rel:"noopener noreferrer"}},[t._v("EF Core 官方文档：自定义操作"),a("OutboundLink")],1)]),t._v(" "),a("h3",{attrs:{id:"创建和删除-api-ensurecreated-和-ensuredeleted"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#创建和删除-api-ensurecreated-和-ensuredeleted"}},[t._v("#")]),t._v(" 创建和删除 API（EnsureCreated 和 EnsureDeleted）")]),t._v(" "),a("p",[t._v("在程序运行中可以调用的 API，用于管理数据库的创建和删除。")]),t._v(" "),a("h2",{attrs:{id:"_5-code-first-模式常见问题"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5-code-first-模式常见问题"}},[t._v("#")]),t._v(" 5 Code First 模式常见问题")]),t._v(" "),a("h3",{attrs:{id:"_5-1-列重命名"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5-1-列重命名"}},[t._v("#")]),t._v(" 5.1 列重命名")]),t._v(" "),a("p",[t._v("具体请查看"),a("a",{attrs:{href:"https://docs.microsoft.com/zh-cn/ef/core/managing-schemas/migrations/managing?tabs=dotnet-core-cli#column-renames",target:"_blank",rel:"noopener noreferrer"}},[t._v("EF Core 官方文档：管理迁移：列重命名"),a("OutboundLink")],1),t._v("。")]),t._v(" "),a("p",[t._v("官方举的例子：如果你将属性从 "),a("code",[t._v("Name")]),t._v(" 重命名为 "),a("code",[t._v("FullName")]),t._v("，EF Core 将生成以下迁移：")]),t._v(" "),a("div",{staticClass:"language-csharp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-csharp"}},[a("code",[t._v("migrationBuilder"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("DropColumn")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token named-parameter punctuation"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Name"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token named-parameter punctuation"}},[t._v("table")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Customers"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\nmigrationBuilder"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token generic-method"}},[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("AddColumn")]),a("span",{pre:!0,attrs:{class:"token generic class-name"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("string")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token named-parameter punctuation"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"FullName"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token named-parameter punctuation"}},[t._v("table")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Customers"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token named-parameter punctuation"}},[t._v("nullable")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("该迁移代码将 "),a("code",[t._v("Name")]),t._v(" 列删除，然后添加新的列 "),a("code",[t._v("FullName")]),t._v("，这样做，会导致 "),a("code",[t._v("Name")]),t._v(" 列原有的数据丢失。")]),t._v(" "),a("p",[t._v("所以需要自行将该迁移代码修改如下：")]),t._v(" "),a("div",{staticClass:"language-csharp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-csharp"}},[a("code",[t._v("migrationBuilder"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("RenameColumn")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token named-parameter punctuation"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Name"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token named-parameter punctuation"}},[t._v("table")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Customers"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token named-parameter punctuation"}},[t._v("newName")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"FullName"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("h2",{attrs:{id:"参考来源"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#参考来源"}},[t._v("#")]),t._v(" 参考来源")]),t._v(" "),a("p",[a("a",{attrs:{href:"https://docs.microsoft.com/zh-cn/ef/core/",target:"_blank",rel:"noopener noreferrer"}},[t._v("EF Core 官方文档"),a("OutboundLink")],1)]),t._v(" "),a("p",[a("a",{attrs:{href:"https://zhuanlan.zhihu.com/p/161107452",target:"_blank",rel:"noopener noreferrer"}},[t._v("EF Core / 基础_从建库到增删改查"),a("OutboundLink")],1)]),t._v(" "),a("p",[a("a",{attrs:{href:"https://blog.csdn.net/KobeNo_1/article/details/118195832",target:"_blank",rel:"noopener noreferrer"}},[t._v("EF Core的基本使用"),a("OutboundLink")],1)])])}),[],!1,null,null,null);s.default=e.exports}}]);