<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>ASP.NET Core 6.0 添加 JWT 认证和授权 | 芦荟柚子茶的博客</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="cl_lis blog">
    
    <link rel="preload" href="/blog/assets/css/0.styles.0b1ac558.css" as="style"><link rel="preload" href="/blog/assets/js/app.558beeb7.js" as="script"><link rel="preload" href="/blog/assets/js/2.c9b070a5.js" as="script"><link rel="preload" href="/blog/assets/js/23.1e210814.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.ab0a2d87.js"><link rel="prefetch" href="/blog/assets/js/11.0cc953f3.js"><link rel="prefetch" href="/blog/assets/js/12.366feb7b.js"><link rel="prefetch" href="/blog/assets/js/13.c133c64c.js"><link rel="prefetch" href="/blog/assets/js/14.80cd9f46.js"><link rel="prefetch" href="/blog/assets/js/15.db67f680.js"><link rel="prefetch" href="/blog/assets/js/16.a3cc2600.js"><link rel="prefetch" href="/blog/assets/js/17.30a20293.js"><link rel="prefetch" href="/blog/assets/js/18.abaa7e33.js"><link rel="prefetch" href="/blog/assets/js/19.c5dd4582.js"><link rel="prefetch" href="/blog/assets/js/20.3ee32d4a.js"><link rel="prefetch" href="/blog/assets/js/21.d7df4dff.js"><link rel="prefetch" href="/blog/assets/js/22.3cfc9a6c.js"><link rel="prefetch" href="/blog/assets/js/24.7f724dd0.js"><link rel="prefetch" href="/blog/assets/js/25.69362e2a.js"><link rel="prefetch" href="/blog/assets/js/26.7efec979.js"><link rel="prefetch" href="/blog/assets/js/27.baab02b4.js"><link rel="prefetch" href="/blog/assets/js/28.22708483.js"><link rel="prefetch" href="/blog/assets/js/29.8131a205.js"><link rel="prefetch" href="/blog/assets/js/3.91f35203.js"><link rel="prefetch" href="/blog/assets/js/30.1dcc6d5c.js"><link rel="prefetch" href="/blog/assets/js/31.cd647998.js"><link rel="prefetch" href="/blog/assets/js/32.f22a6677.js"><link rel="prefetch" href="/blog/assets/js/33.031d81c8.js"><link rel="prefetch" href="/blog/assets/js/34.dc2b0687.js"><link rel="prefetch" href="/blog/assets/js/35.55225650.js"><link rel="prefetch" href="/blog/assets/js/36.01a82d7c.js"><link rel="prefetch" href="/blog/assets/js/37.9e6b4b86.js"><link rel="prefetch" href="/blog/assets/js/38.947002a2.js"><link rel="prefetch" href="/blog/assets/js/39.d252a4d8.js"><link rel="prefetch" href="/blog/assets/js/4.d2bc884a.js"><link rel="prefetch" href="/blog/assets/js/5.8deafdd4.js"><link rel="prefetch" href="/blog/assets/js/6.b88d790a.js"><link rel="prefetch" href="/blog/assets/js/7.5a873c47.js"><link rel="prefetch" href="/blog/assets/js/8.b3ddc9f5.js"><link rel="prefetch" href="/blog/assets/js/9.45271a8d.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.0b1ac558.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">芦荟柚子茶的博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/blog/projects/" class="nav-link">
  项目
</a></div><div class="nav-item"><a href="/blog/record/" class="nav-link">
  记录
</a></div><div class="nav-item"><a href="/blog/fronted/" class="nav-link">
  前端
</a></div><div class="nav-item"><a href="/blog/backend/" class="nav-link router-link-active">
  后端
</a></div><div class="nav-item"><a href="/blog/thanks/" class="nav-link">
  感谢
</a></div> <a href="https://github.com/lisheng741/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/blog/projects/" class="nav-link">
  项目
</a></div><div class="nav-item"><a href="/blog/record/" class="nav-link">
  记录
</a></div><div class="nav-item"><a href="/blog/fronted/" class="nav-link">
  前端
</a></div><div class="nav-item"><a href="/blog/backend/" class="nav-link router-link-active">
  后端
</a></div><div class="nav-item"><a href="/blog/thanks/" class="nav-link">
  感谢
</a></div> <a href="https://github.com/lisheng741/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>后端</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/backend/" aria-current="page" class="sidebar-link">目录</a></li><li><a href="/blog/backend/EFCore配置模型.html" class="sidebar-link">EF Core 配置模型</a></li><li><a href="/blog/backend/EFCore的DbFirst模式.html" class="sidebar-link">EFCore 的 DbFirst 模式</a></li><li><a href="/blog/backend/EFCore的CodeFirst模式.html" class="sidebar-link">EF Core 的 Code First 模式</a></li><li><a href="/blog/backend/EFCore概述.html" class="sidebar-link">EF Core 概述</a></li><li><a href="/blog/backend/EFCore数据过滤.html" class="sidebar-link">EF Core 数据过滤</a></li><li><a href="/blog/backend/EFCore关联查询.html" class="sidebar-link">EF Core 的关联查询</a></li><li><a href="/blog/backend/ASP.NETCore添加JWT.html" class="active sidebar-link">ASP.NET Core 6.0 添加 JWT 认证和授权</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/backend/ASP.NETCore添加JWT.html#_1-前言" class="sidebar-link">1 前言</a></li><li class="sidebar-sub-header"><a href="/blog/backend/ASP.NETCore添加JWT.html#_2-认证-authentication" class="sidebar-link">2 认证（Authentication）</a></li><li class="sidebar-sub-header"><a href="/blog/backend/ASP.NETCore添加JWT.html#_3-授权-authorization" class="sidebar-link">3 授权（Authorization）</a></li><li class="sidebar-sub-header"><a href="/blog/backend/ASP.NETCore添加JWT.html#_4-源码" class="sidebar-link">4 源码</a></li><li class="sidebar-sub-header"><a href="/blog/backend/ASP.NETCore添加JWT.html#参考来源" class="sidebar-link">参考来源</a></li></ul></li><li><a href="/blog/backend/ASP.NETCore模型验证.html" class="sidebar-link">ASP.NET Core 6.0 基于模型验证的数据验证</a></li><li><a href="/blog/backend/ASP.NETCore开启CORS.html" class="sidebar-link">ASP.NET Core 6.0 开启 CORS 跨域请求</a></li><li><a href="/blog/backend/ASP.NETCore定时任务Quartz.html" class="sidebar-link">ASP.NET Core 6.0 定时任务 Quartz</a></li><li><a href="/blog/backend/ASP.NETCore关于CSRedis.html" class="sidebar-link">ASP.NET Core 关于 CSRedis</a></li><li><a href="/blog/backend/ASP.NETCore关于Cache.html" class="sidebar-link">ASP.NET Core 6.0 关于 Cache</a></li><li><a href="/blog/backend/ASP.NETCore关于Autofac使用.html" class="sidebar-link">ASP.NET Core 6.0 关于 Autofac 使用</a></li><li><a href="/blog/backend/ASP.NETCore使用AutoMapper.html" class="sidebar-link">ASP.NET Core 6.0 使用 AutoMapper</a></li><li><a href="/blog/backend/ASP.NETCore产生连续Guid.html" class="sidebar-link">ASP.NET Core 产生连续 Guid</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="asp-net-core-6-0-添加-jwt-认证和授权"><a href="#asp-net-core-6-0-添加-jwt-认证和授权" class="header-anchor">#</a> ASP.NET Core 6.0 添加 JWT 认证和授权</h1> <p></p><div class="table-of-contents"><ul><li><a href="#_1-前言">1 前言</a><ul><li><a href="#_1-1-本文介绍">1.1 本文介绍</a></li><li><a href="#_1-2-相关名词">1.2 相关名词</a></li></ul></li><li><a href="#_2-认证-authentication">2 认证（Authentication）</a><ul><li><a href="#_2-1-基本步骤">2.1 基本步骤</a></li><li><a href="#_2-2-安装-nuget-包">2.2 安装 Nuget 包</a></li><li><a href="#_2-3-准备配置信息">2.3 准备配置信息</a></li><li><a href="#_2-4-注册服务和调用中间件">2.4 注册服务和调用中间件</a></li><li><a href="#_2-5-jwthelper-类实现">2.5 JwtHelper 类实现</a></li><li><a href="#_2-6-控制器配置">2.6 控制器配置</a></li><li><a href="#_2-7-测试调用">2.7 测试调用</a></li></ul></li><li><a href="#_3-授权-authorization">3 授权（Authorization）</a><ul><li><a href="#_3-1-基本介绍">3.1 基本介绍</a></li><li><a href="#_3-2-相关标签-attribute">3.2 相关标签（Attribute）</a></li><li><a href="#_3-3-授权方式">3.3 授权方式</a></li><li><a href="#_3-4-基于策略-policy-的授权">3.4 基于策略（Policy）的授权</a></li><li><a href="#_3-5-授权过程">3.5 授权过程</a></li></ul></li><li><a href="#_4-源码">4 源码</a></li><li><a href="#参考来源">参考来源</a></li></ul></div><p></p> <h2 id="_1-前言"><a href="#_1-前言" class="header-anchor">#</a> 1 前言</h2> <h3 id="_1-1-本文介绍"><a href="#_1-1-本文介绍" class="header-anchor">#</a> 1.1 本文介绍</h3> <p>本文将分别简单介绍 Authentication（认证） 和 Authorization（授权）。</p> <p>并以简单的例子在 ASP.NET Core 6.0 的 WebAPI 中以 JWT 方案实现认证，并辅以相应的授权例子。</p> <h3 id="_1-2-相关名词"><a href="#_1-2-相关名词" class="header-anchor">#</a> 1.2 相关名词</h3> <p>Authentication 和 Authorization 长得很像，傻傻分不清楚。</p> <p>Authentication（认证）：标识用户的身份，一般发生在登录的时候。</p> <p>Authorization（授权）：授予用户权限，指定用户能访问哪些资源；授权的前提是知道这个用户是谁，所以授权必须在认证之后。</p> <p>其实，认证和授权其实是不分家的。</p> <h2 id="_2-认证-authentication"><a href="#_2-认证-authentication" class="header-anchor">#</a> 2 认证（Authentication）</h2> <h3 id="_2-1-基本步骤"><a href="#_2-1-基本步骤" class="header-anchor">#</a> 2.1 基本步骤</h3> <ol><li>安装相关 Nuget 包：Microsoft.AspNetCore.Authentication.JwtBearer</li> <li>准备配置信息（密钥等）</li> <li>注册服务</li> <li>调用中间件</li> <li>实现一个 JwtHelper，用于生成 Token</li> <li>控制器限制访问（添加 Authorize 标签）</li></ol> <h3 id="_2-2-安装-nuget-包"><a href="#_2-2-安装-nuget-包" class="header-anchor">#</a> 2.2 安装 Nuget 包</h3> <p>安装 Microsoft.AspNetCore.Authentication.JwtBearer</p> <p>在控制台中：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>dotnet <span class="token function">add</span> package Microsoft.AspNetCore.Authentication.JwtBearer -v <span class="token number">6.0</span>.1
</code></pre></div><h3 id="_2-3-准备配置信息"><a href="#_2-3-准备配置信息" class="header-anchor">#</a> 2.3 准备配置信息</h3> <p>在 appsetting.json 中，添加一个 Jwt 节点</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token property">&quot;Jwt&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;SecretKey&quot;</span><span class="token operator">:</span> <span class="token string">&quot;lisheng741@qq.com&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;Issuer&quot;</span><span class="token operator">:</span> <span class="token string">&quot;WebAppIssuer&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;Audience&quot;</span><span class="token operator">:</span> <span class="token string">&quot;WebAppAudience&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_2-4-注册服务和调用中间件"><a href="#_2-4-注册服务和调用中间件" class="header-anchor">#</a> 2.4 注册服务和调用中间件</h3> <p>在 Program.cs 文件中注册服务，和调用相关中间件。</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token comment">//引入所需的命名空间</span>
<span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>AspNetCore<span class="token punctuation">.</span>Authentication<span class="token punctuation">.</span>JwtBearer</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>IdentityModel<span class="token punctuation">.</span>Tokens</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Text</span><span class="token punctuation">;</span>

<span class="token class-name"><span class="token keyword">var</span></span> configuration <span class="token operator">=</span> builder<span class="token punctuation">.</span>Configuration<span class="token punctuation">;</span>

<span class="token comment">//注册服务</span>
builder<span class="token punctuation">.</span>Services<span class="token punctuation">.</span><span class="token function">AddAuthentication</span><span class="token punctuation">(</span>options <span class="token operator">=&gt;</span>
<span class="token punctuation">{</span>
    options<span class="token punctuation">.</span>DefaultScheme <span class="token operator">=</span> JwtBearerDefaults<span class="token punctuation">.</span>AuthenticationScheme<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">AddJwtBearer</span><span class="token punctuation">(</span>options <span class="token operator">=&gt;</span>
<span class="token punctuation">{</span>
    options<span class="token punctuation">.</span>TokenValidationParameters <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">TokenValidationParameters</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        ValidateIssuer <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">//是否验证Issuer</span>
        ValidIssuer <span class="token operator">=</span> configuration<span class="token punctuation">[</span><span class="token string">&quot;Jwt:Issuer&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">//发行人Issuer</span>
        ValidateAudience <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">//是否验证Audience</span>
        ValidAudience <span class="token operator">=</span> configuration<span class="token punctuation">[</span><span class="token string">&quot;Jwt:Audience&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">//订阅人Audience</span>
        ValidateIssuerSigningKey <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">//是否验证SecurityKey</span>
        IssuerSigningKey <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">SymmetricSecurityKey</span><span class="token punctuation">(</span>Encoding<span class="token punctuation">.</span>UTF8<span class="token punctuation">.</span><span class="token function">GetBytes</span><span class="token punctuation">(</span>configuration<span class="token punctuation">[</span><span class="token string">&quot;Jwt:SecretKey&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">//SecurityKey</span>
        ValidateLifetime <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">//是否验证失效时间</span>
        ClockSkew <span class="token operator">=</span> TimeSpan<span class="token punctuation">.</span><span class="token function">FromSeconds</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">//过期时间容错值，解决服务器端时间不同步问题（秒）</span>
        RequireExpirationTime <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//调用中间件：UseAuthentication（认证），必须在所有需要身份认证的中间件前调用，比如 UseAuthorization（授权）。</span>
app<span class="token punctuation">.</span><span class="token function">UseAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">UseAuthorization</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_2-5-jwthelper-类实现"><a href="#_2-5-jwthelper-类实现" class="header-anchor">#</a> 2.5 JwtHelper 类实现</h3> <p>主要是用于生成 JWT 的 Token。</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>IdentityModel<span class="token punctuation">.</span>Tokens</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>IdentityModel<span class="token punctuation">.</span>Tokens<span class="token punctuation">.</span>Jwt</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Security<span class="token punctuation">.</span>Claims</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Text</span><span class="token punctuation">;</span>

<span class="token keyword">namespace</span> <span class="token namespace">AuthenticationTest</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JwtHelper</span>
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IConfiguration</span> _configuration<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">JwtHelper</span><span class="token punctuation">(</span><span class="token class-name">IConfiguration</span> configuration<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _configuration <span class="token operator">=</span> configuration<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> <span class="token function">CreateToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// 1. 定义需要使用到的Claims</span>
        <span class="token class-name"><span class="token keyword">var</span></span> claims <span class="token operator">=</span> <span class="token keyword">new</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Claim</span><span class="token punctuation">(</span>ClaimTypes<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> <span class="token string">&quot;u_admin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">//HttpContext.User.Identity.Name</span>
            <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Claim</span><span class="token punctuation">(</span>ClaimTypes<span class="token punctuation">.</span>Role<span class="token punctuation">,</span> <span class="token string">&quot;r_admin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">//HttpContext.User.IsInRole(&quot;r_admin&quot;)</span>
            <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Claim</span><span class="token punctuation">(</span>JwtRegisteredClaimNames<span class="token punctuation">.</span>Jti<span class="token punctuation">,</span> <span class="token string">&quot;admin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Claim</span><span class="token punctuation">(</span><span class="token string">&quot;Username&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Admin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Claim</span><span class="token punctuation">(</span><span class="token string">&quot;Name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;超级管理员&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token comment">// 2. 从 appsettings.json 中读取SecretKey</span>
        <span class="token class-name"><span class="token keyword">var</span></span> secretKey <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">SymmetricSecurityKey</span><span class="token punctuation">(</span>Encoding<span class="token punctuation">.</span>UTF8<span class="token punctuation">.</span><span class="token function">GetBytes</span><span class="token punctuation">(</span>_configuration<span class="token punctuation">[</span><span class="token string">&quot;Jwt:SecretKey&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 3. 选择加密算法</span>
        <span class="token class-name"><span class="token keyword">var</span></span> algorithm <span class="token operator">=</span> SecurityAlgorithms<span class="token punctuation">.</span>HmacSha256<span class="token punctuation">;</span>

        <span class="token comment">// 4. 生成Credentials</span>
        <span class="token class-name"><span class="token keyword">var</span></span> signingCredentials <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">SigningCredentials</span><span class="token punctuation">(</span>secretKey<span class="token punctuation">,</span> algorithm<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 5. 根据以上，生成token</span>
        <span class="token class-name"><span class="token keyword">var</span></span> jwtSecurityToken <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">JwtSecurityToken</span><span class="token punctuation">(</span>
            _configuration<span class="token punctuation">[</span><span class="token string">&quot;Jwt:Issuer&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>     <span class="token comment">//Issuer</span>
            _configuration<span class="token punctuation">[</span><span class="token string">&quot;Jwt:Audience&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>   <span class="token comment">//Audience</span>
            claims<span class="token punctuation">,</span>                          <span class="token comment">//Claims,</span>
            DateTime<span class="token punctuation">.</span>Now<span class="token punctuation">,</span>                    <span class="token comment">//notBefore</span>
            DateTime<span class="token punctuation">.</span>Now<span class="token punctuation">.</span><span class="token function">AddSeconds</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token comment">//expires</span>
            signingCredentials               <span class="token comment">//Credentials</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 6. 将token变为string</span>
        <span class="token class-name"><span class="token keyword">var</span></span> token <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">JwtSecurityTokenHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">WriteToken</span><span class="token punctuation">(</span>jwtSecurityToken<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> token<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>该 JwtHelper 依赖于 IConfiguration（为了读取配置文件），将 JwtHelper 的创建交由 DI 容器，在 Program.cs 中添加服务：</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>builder<span class="token punctuation">.</span>Services<span class="token punctuation">.</span><span class="token function">AddSingleton</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">JwtHelper</span><span class="token punctuation">(</span>configuration<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>将 JwtHelper 注册为单例模式。</p> <h3 id="_2-6-控制器配置"><a href="#_2-6-控制器配置" class="header-anchor">#</a> 2.6 控制器配置</h3> <p>新建一个 AccountController，以构造函数方式注入 JwtHelper，添加两个 Action：GetToken 用于获取 Token，GetTest 打上 [Authorize] 标签用于验证认证。</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>AspNetCore<span class="token punctuation">.</span>Authorization</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>AspNetCore<span class="token punctuation">.</span>Mvc</span><span class="token punctuation">;</span>

<span class="token keyword">namespace</span> <span class="token namespace">AuthenticationTest<span class="token punctuation">.</span>Controllers</span><span class="token punctuation">;</span>

<span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Route</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">&quot;api/[controller]/[action]&quot;</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">ApiController</span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AccountController</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">ControllerBase</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">JwtHelper</span> _jwtHelper<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">AccountController</span><span class="token punctuation">(</span><span class="token class-name">JwtHelper</span> jwtHelper<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _jwtHelper <span class="token operator">=</span> jwtHelper<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">HttpGet</span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">ActionResult<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">&gt;</span></span> <span class="token function">GetToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> _jwtHelper<span class="token punctuation">.</span><span class="token function">CreateToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Authorize</span></span><span class="token punctuation">]</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">HttpGet</span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">ActionResult<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">&gt;</span></span> <span class="token function">GetTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;Test Authorize&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_2-7-测试调用"><a href="#_2-7-测试调用" class="header-anchor">#</a> 2.7 测试调用</h3> <p><strong>方式一：通过 Postman、Apifox 等接口调试软件调试</strong></p> <p>使用 Postman 调用 /api/Account/GetToken 生成 Token</p> <p>在调用 /api/Account/GetTest 时传入 Token，得到返回结果</p> <p><strong>方式二：在浏览器控制台调试</strong></p> <p>调试 /api/Account/GetToken</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;readystatechange&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>readyState <span class="token operator">===</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>token <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>responseText<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//这里用了一个全局变量 token，为下一个接口服务</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">&quot;GET&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/api/Account/GetToken&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>调试 /api/Account/GetTest</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;readystatechange&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>readyState <span class="token operator">===</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>responseText<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//this.status为响应状态码，401为无认证状态</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">&quot;GET&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/api/Account/GetTest&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function">setRequestHeader</span><span class="token punctuation">(</span><span class="token string">&quot;Authorization&quot;</span><span class="token punctuation">,</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Bearer </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>token<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//附带上 token</span>
xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="_3-授权-authorization"><a href="#_3-授权-authorization" class="header-anchor">#</a> 3 授权（Authorization）</h2> <p><strong>注意</strong>：授权必须基于认证，即：若没有完成上文关于认证的配置，则下面的授权是不会成功的。</p> <h3 id="_3-1-基本介绍"><a href="#_3-1-基本介绍" class="header-anchor">#</a> 3.1 基本介绍</h3> <p>其实 JWT 是认证的一种方案，其他的方案如 Cookies。本节介绍的授权，实际上与 JWT 没有什么关系，是基于 ASP.NET Core 的基本能力。</p> <p>这一部分，将先介绍相关标签、授权方式，再介绍基于策略的授权。这三部分大致的内容如下描述：</p> <p>相关标签：Authorize 和 AllowAnonymous</p> <p>授权方式：介绍三种授权方式（Policy、Role、Scheme）</p> <p>基于策略（Policy）的授权：深入 Policy 授权方式</p> <h3 id="_3-2-相关标签-attribute"><a href="#_3-2-相关标签-attribute" class="header-anchor">#</a> 3.2 相关标签（Attribute）</h3> <p>授权相关标签具体请查考官方文档<a href="https://docs.microsoft.com/zh-cn/aspnet/core/security/authorization/simple?view=aspnetcore-6.0" target="_blank" rel="noopener noreferrer">简单授权<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h4 id="_3-2-1-authorize"><a href="#_3-2-1-authorize" class="header-anchor">#</a> 3.2.1 [Authorize]</h4> <p>打上该标签的 Controller 或 Action 必须经过认证，且可以标识需要满足哪些授权规则。</p> <p>授权规则可以是 Policy（策略）、Roles（角色） 或 AuthenticationSchemes（方案）。</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Authorize</span><span class="token attribute-arguments"><span class="token punctuation">(</span>Policy <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> Roles <span class="token operator">=</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> AuthenticationSchemes <span class="token operator">=</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
</code></pre></div><h4 id="_3-2-2-allowanonymous"><a href="#_3-2-2-allowanonymous" class="header-anchor">#</a> 3.2.2 [AllowAnonymous]</h4> <p>允许匿名访问，级别高于 [Authorize] ，若两者同时作用，将生效 [AllowAnonymous]</p> <h3 id="_3-3-授权方式"><a href="#_3-3-授权方式" class="header-anchor">#</a> 3.3 授权方式</h3> <p>基本上授权只有：Policy、Role、Scheme 这3种方式，对应 Authorize 标签的3个属性。</p> <h4 id="_3-3-1-policy-策略"><a href="#_3-3-1-policy-策略" class="header-anchor">#</a> 3.3.1 Policy（策略）</h4> <p>推荐的授权方式，在 ASP.NET Core 的官方文档提及最多的。一个 Policy 可以包含多个要求（要求可能是 Role 匹配，也可能是 Claims 匹配，也可能是其他方式。）</p> <p>下面举个基础例子（说是基础例子，主要是基于 Policy 的授权方式可以不断深入追加一些配置）：</p> <p>在 Program.cs 中，添加两条 Policy：</p> <p>policy1 要求用户拥有一个 Claim，其 ClaimType 值为 EmployeeNumber。</p> <p>policy2 要求用户拥有一个 Claim，其 ClaimType 值为 EmployeeNumber，且其 ClaimValue 值为1、2、3、4 或 5。</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>builder<span class="token punctuation">.</span>Services<span class="token punctuation">.</span><span class="token function">AddAuthorization</span><span class="token punctuation">(</span>options <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    options<span class="token punctuation">.</span><span class="token function">AddPolicy</span><span class="token punctuation">(</span><span class="token string">&quot;policy1&quot;</span><span class="token punctuation">,</span> policy <span class="token operator">=&gt;</span> policy<span class="token punctuation">.</span><span class="token function">RequireClaim</span><span class="token punctuation">(</span><span class="token string">&quot;EmployeeNumber&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    options<span class="token punctuation">.</span><span class="token function">AddPolicy</span><span class="token punctuation">(</span><span class="token string">&quot;policy2&quot;</span><span class="token punctuation">,</span> policy <span class="token operator">=&gt;</span> policy<span class="token punctuation">.</span><span class="token function">RequireClaim</span><span class="token punctuation">(</span><span class="token string">&quot;EmployeeNumber&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;2&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;3&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;4&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;5&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>在控制器中添加 [Authorize] 标签即可生效：</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Authorize</span><span class="token attribute-arguments"><span class="token punctuation">(</span>Policy <span class="token operator">=</span> <span class="token string">&quot;policy1&quot;</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestController</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">ControllerBase</span></span>
</code></pre></div><p>或在控制器的 Action 上：</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestController</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">ControllerBase</span></span>
<span class="token punctuation">{</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Authorize</span><span class="token attribute-arguments"><span class="token punctuation">(</span>Policy <span class="token operator">=</span> <span class="token string">&quot;policy1&quot;</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">ActionResult<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">&gt;</span></span> GetTest <span class="token operator">=&gt;</span> <span class="token string">&quot;GetTest&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_3-3-2-role-角色"><a href="#_3-3-2-role-角色" class="header-anchor">#</a> 3.3.2 Role（角色）</h4> <p>基于角色授权，只要用户拥有角色，即可通过授权验证。</p> <p>在认证时，给用户添加角色相关的 Claim ，即可标识用户拥有的角色（注：一个用户可以拥有多个角色的 Claim），如：</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">new</span> <span class="token constructor-invocation class-name">Claim</span><span class="token punctuation">(</span>ClaimTypes<span class="token punctuation">.</span>Role<span class="token punctuation">,</span> <span class="token string">&quot;admin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token keyword">new</span> <span class="token constructor-invocation class-name">Claim</span><span class="token punctuation">(</span>ClaimTypes<span class="token punctuation">.</span>Role<span class="token punctuation">,</span> <span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span>
</code></pre></div><p>在 Controller 或 Action 中：</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Authorize</span><span class="token attribute-arguments"><span class="token punctuation">(</span>Roles <span class="token operator">=</span> <span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestController</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">ControllerBase</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">ActionResult<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">&gt;</span></span> GetUser <span class="token operator">=&gt;</span> <span class="token string">&quot;GetUser&quot;</span><span class="token punctuation">;</span>
    
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Authorize</span><span class="token attribute-arguments"><span class="token punctuation">(</span>Roles <span class="token operator">=</span> <span class="token string">&quot;admin&quot;</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span> <span class="token comment">//与控制器的Authorize叠加作用，除了拥有user，还需拥有admin</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">ActionResult<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">&gt;</span></span> GetAdmin <span class="token operator">=&gt;</span> <span class="token string">&quot;GetAdmin&quot;</span><span class="token punctuation">;</span>
    
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Authorize</span><span class="token attribute-arguments"><span class="token punctuation">(</span>Roles <span class="token operator">=</span> <span class="token string">&quot;user,admin&quot;</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span> <span class="token comment">//user 或 admin 其一满足即可</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">ActionResult<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">&gt;</span></span> GetUserOrAdmin <span class="token operator">=&gt;</span> <span class="token string">&quot;GetUserOrAdmin&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_3-3-3-scheme-方案"><a href="#_3-3-3-scheme-方案" class="header-anchor">#</a> 3.3.3 Scheme（方案）</h4> <p>方案如：Cookies 和 Bearer，当然也可以是自定义的方案。</p> <p>由于这种方式不常用，这里不做展开，请参考官方文档<a href="https://docs.microsoft.com/zh-cn/aspnet/core/security/authorization/limitingidentitybyscheme?view=aspnetcore-6.0" target="_blank" rel="noopener noreferrer">按方案限制标识<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <h3 id="_3-4-基于策略-policy-的授权"><a href="#_3-4-基于策略-policy-的授权" class="header-anchor">#</a> 3.4 基于策略（Policy）的授权</h3> <p>上面已经提及了一个基于策略授权的基础例子，下面将继续深入这种授权方式。</p> <p>授权主要的方式，是通过 Handler 程序判断授权，需要实现的接口是 IAuthorizationHandler。</p> <p>基于策略的授权，需要继承 AuthorizationHandler&lt;TRequirement&gt; 并重写 HandleRequirementAsync 方法，该方法需要 Requirement 作为入参，相关的接口是 IAuthorizationRequirement。</p> <p>具体步骤为：</p> <ol><li>准备自定义的 Requirement 实现 IAuthorizationRequirement</li> <li>自定义 Handler 程序继承 AuthorizationHandler&lt;TRequirement&gt; 并重写 HandleRequirementAsync 方法</li></ol> <h4 id="_3-4-1-定义权限项"><a href="#_3-4-1-定义权限项" class="header-anchor">#</a> 3.4.1 定义权限项</h4> <p>在实现 Requirement 之前，我们需要先定义一些权限项，主要用于后续作为 Policy 的名称，并传入 我们实现的 Requirement 之中。</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Permissions</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">const</span> <span class="token class-name"><span class="token keyword">string</span></span> User <span class="token operator">=</span> <span class="token string">&quot;User&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">const</span> <span class="token class-name"><span class="token keyword">string</span></span> UserCreate <span class="token operator">=</span> User <span class="token operator">+</span> <span class="token string">&quot;.Create&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">const</span> <span class="token class-name"><span class="token keyword">string</span></span> UserDelete <span class="token operator">=</span> User <span class="token operator">+</span> <span class="token string">&quot;.Delete&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">const</span> <span class="token class-name"><span class="token keyword">string</span></span> UserUpdate <span class="token operator">=</span> User <span class="token operator">+</span> <span class="token string">&quot;.Update&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>如上，定义了“增”、“删”、“改”等权限，其中 User 将拥有完整权限。</p> <h4 id="_3-4-2-实现-requirement"><a href="#_3-4-2-实现-requirement" class="header-anchor">#</a> 3.4.2 实现 Requirement</h4> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PermissionAuthorizationRequirement</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IAuthorizationRequirement</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">PermissionAuthorizationRequirement</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> name<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Name <span class="token operator">=</span> name<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Name <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>使用 Name 属性表示权限的名称，与 Permissions 中的常量对应。</p> <h4 id="_3-4-3-实现授权处理程序-handler"><a href="#_3-4-3-实现授权处理程序-handler" class="header-anchor">#</a> 3.4.3 实现授权处理程序 Handler</h4> <p>这里<strong>假定</strong>用户的 Claim 中 ClaimType 为 Permission 的项，如：</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">new</span> <span class="token constructor-invocation class-name">Claim</span><span class="token punctuation">(</span><span class="token string">&quot;Permission&quot;</span><span class="token punctuation">,</span> Permissions<span class="token punctuation">.</span>UserCreate<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token keyword">new</span> <span class="token constructor-invocation class-name">Claim</span><span class="token punctuation">(</span><span class="token string">&quot;Permission&quot;</span><span class="token punctuation">,</span> Permissions<span class="token punctuation">.</span>UserUpdate<span class="token punctuation">)</span>
</code></pre></div><p>如上，标识该用户用户 UserCreate 和 UserUpdate 的权限。</p> <p><strong>注意</strong>：当然，实际程序我们肯定不是这样实现的，这里只是简易示例。</p> <p>接着，实现一个授权 Handler：</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PermissionAuthorizationHandler</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">AuthorizationHandler<span class="token punctuation">&lt;</span>PermissionAuthorizationRequirement<span class="token punctuation">&gt;</span></span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">protected</span> <span class="token keyword">override</span> <span class="token return-type class-name">Task</span> <span class="token function">HandleRequirementAsync</span><span class="token punctuation">(</span><span class="token class-name">AuthorizationHandlerContext</span> context<span class="token punctuation">,</span> <span class="token class-name">PermissionAuthorizationRequirement</span> requirement<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name"><span class="token keyword">var</span></span> permissions <span class="token operator">=</span> context<span class="token punctuation">.</span>User<span class="token punctuation">.</span>Claims<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span>_ <span class="token operator">=&gt;</span> _<span class="token punctuation">.</span>Type <span class="token operator">==</span> <span class="token string">&quot;Permission&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span>_ <span class="token operator">=&gt;</span> _<span class="token punctuation">.</span>Value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>permissions<span class="token punctuation">.</span><span class="token function">Any</span><span class="token punctuation">(</span>_ <span class="token operator">=&gt;</span> _<span class="token punctuation">.</span><span class="token function">StartsWith</span><span class="token punctuation">(</span>requirement<span class="token punctuation">.</span>Name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            context<span class="token punctuation">.</span><span class="token function">Succeed</span><span class="token punctuation">(</span>requirement<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> Task<span class="token punctuation">.</span>CompletedTask<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>运行 <code>HandleRequirementAsync</code> 时，会将用户的 Claim 中 ClaimType 为 Permission 的项取出，并获取其 Value 组成一个 <code>List&lt;string&gt;</code>。</p> <p>接着验证 Requirement 是否满足授权，满足则运行 <code>context.Succeed</code> 。</p> <h4 id="_3-4-4-注册授权处理程序服务"><a href="#_3-4-4-注册授权处理程序服务" class="header-anchor">#</a> 3.4.4 注册授权处理程序服务</h4> <p>在 Program.cs 中，将 <code>PermissionAuthorizationHandler</code> 添加到 DI 中：</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>builder<span class="token punctuation">.</span>Services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddSingleton</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IAuthorizationHandler<span class="token punctuation">,</span> PermissionAuthorizationHandler<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="_3-4-5-添加授权策略"><a href="#_3-4-5-添加授权策略" class="header-anchor">#</a> 3.4.5 添加授权策略</h4> <div class="language-csharp extra-class"><pre class="language-csharp"><code>builder<span class="token punctuation">.</span>Services<span class="token punctuation">.</span><span class="token function">AddAuthorization</span><span class="token punctuation">(</span>options <span class="token operator">=&gt;</span>
<span class="token punctuation">{</span>
    options<span class="token punctuation">.</span><span class="token function">AddPolicy</span><span class="token punctuation">(</span>Permissions<span class="token punctuation">.</span>UserCreate<span class="token punctuation">,</span> policy <span class="token operator">=&gt;</span> policy<span class="token punctuation">.</span><span class="token function">AddRequirements</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">PermissionAuthorizationRequirement</span><span class="token punctuation">(</span>Permissions<span class="token punctuation">.</span>UserCreate<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    options<span class="token punctuation">.</span><span class="token function">AddPolicy</span><span class="token punctuation">(</span>Permissions<span class="token punctuation">.</span>UserUpdate<span class="token punctuation">,</span> policy <span class="token operator">=&gt;</span> policy<span class="token punctuation">.</span><span class="token function">AddRequirements</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">PermissionAuthorizationRequirement</span><span class="token punctuation">(</span>Permissions<span class="token punctuation">.</span>UserUpdate<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    options<span class="token punctuation">.</span><span class="token function">AddPolicy</span><span class="token punctuation">(</span>Permissions<span class="token punctuation">.</span>UserDelete<span class="token punctuation">,</span> policy <span class="token operator">=&gt;</span> policy<span class="token punctuation">.</span><span class="token function">AddRequirements</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">PermissionAuthorizationRequirement</span><span class="token punctuation">(</span>Permissions<span class="token punctuation">.</span>UserDelete<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="_3-4-6-控制器配置"><a href="#_3-4-6-控制器配置" class="header-anchor">#</a> 3.4.6 控制器配置</h4> <p>控制器如下：</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Route</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">&quot;api/[controller]/[action]&quot;</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">ApiController</span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">ControllerBase</span></span>
<span class="token punctuation">{</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">HttpGet</span></span><span class="token punctuation">]</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Authorize</span><span class="token attribute-arguments"><span class="token punctuation">(</span>Permissions<span class="token punctuation">.</span>UserCreate<span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">ActionResult<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">&gt;</span></span> <span class="token function">UserCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token string">&quot;UserCreate&quot;</span><span class="token punctuation">;</span>

    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">HttpGet</span></span><span class="token punctuation">]</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Authorize</span><span class="token attribute-arguments"><span class="token punctuation">(</span>Permissions<span class="token punctuation">.</span>UserUpdate<span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">ActionResult<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">&gt;</span></span> <span class="token function">UserUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token string">&quot;UserUpdate&quot;</span><span class="token punctuation">;</span>

    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">HttpGet</span></span><span class="token punctuation">]</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Authorize</span><span class="token attribute-arguments"><span class="token punctuation">(</span>Permissions<span class="token punctuation">.</span>UserDelete<span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">ActionResult<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">&gt;</span></span> <span class="token function">UserDelete</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token string">&quot;UserDelete&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>基于上面的<strong>假定</strong>，用户访问接口的情况如下：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>/api/User/UserCreate <span class="token comment">#成功</span>
/api/User/UserUpdate <span class="token comment">#成功</span>
/api/User/UserDelete <span class="token comment">#403无权限</span>
</code></pre></div><p>至此，基于策略（Policy）的授权其实已经<strong>基本完成</strong>。</p> <p>接下去的内容，将是对上面一些内容的完善或补充。</p> <h4 id="_3-4-7-完善-实现策略提供程序-policyprovider"><a href="#_3-4-7-完善-实现策略提供程序-policyprovider" class="header-anchor">#</a> 3.4.7 完善：实现策略提供程序 PolicyProvider</h4> <p>一般添加授权策略如下是在 Program.cs 中，方式如下：</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>builder<span class="token punctuation">.</span>Services<span class="token punctuation">.</span><span class="token function">AddAuthorization</span><span class="token punctuation">(</span>options <span class="token operator">=&gt;</span>
<span class="token punctuation">{</span>
    options<span class="token punctuation">.</span><span class="token function">AddPolicy</span><span class="token punctuation">(</span><span class="token string">&quot;policy&quot;</span><span class="token punctuation">,</span> policy <span class="token operator">=&gt;</span> policy<span class="token punctuation">.</span><span class="token function">RequireClaim</span><span class="token punctuation">(</span><span class="token string">&quot;EmployeeNumber&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>通过 AuthorizationOptions.AddPolicy 添加授权策略这种方式不灵活，无法动态添加。</p> <p>通过实现 IAuthorizationPolicyProvider 并添加到 DI 中，可以实现动态添加 Policy。</p> <p>IAuthorizationPolicyProvider 的默认实现为 DefaultAuthorizationPolicyProvider 。</p> <p>实现一个 PolicyProvider 如下：</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestAuthorizationPolicyProvider</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">DefaultAuthorizationPolicyProvider</span><span class="token punctuation">,</span> <span class="token class-name">IAuthorizationPolicyProvider</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">TestAuthorizationPolicyProvider</span><span class="token punctuation">(</span><span class="token class-name">IOptions<span class="token punctuation">&lt;</span>AuthorizationOptions<span class="token punctuation">&gt;</span></span> options<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">base</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">new</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>AuthorizationPolicy<span class="token punctuation">&gt;</span></span> <span class="token function">GetDefaultPolicyAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token operator">=&gt;</span>  <span class="token keyword">base</span><span class="token punctuation">.</span><span class="token function">GetDefaultPolicyAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">new</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>AuthorizationPolicy<span class="token punctuation">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">GetFallbackPolicyAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token operator">=&gt;</span> <span class="token keyword">base</span><span class="token punctuation">.</span><span class="token function">GetFallbackPolicyAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">new</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>AuthorizationPolicy<span class="token punctuation">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">GetPolicyAsync</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> policyName<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>policyName<span class="token punctuation">.</span><span class="token function">StartsWith</span><span class="token punctuation">(</span>Permissions<span class="token punctuation">.</span>User<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token class-name"><span class="token keyword">var</span></span> policy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">AuthorizationPolicyBuilder</span><span class="token punctuation">(</span>JwtBearerDefaults<span class="token punctuation">.</span>AuthenticationScheme<span class="token punctuation">)</span><span class="token punctuation">;</span>
            policy<span class="token punctuation">.</span><span class="token function">AddRequirements</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">PermissionAuthorizationRequirement</span><span class="token punctuation">(</span>policyName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> Task<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">FromResult</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>AuthorizationPolicy<span class="token punctuation">?</span><span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>policy<span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">base</span><span class="token punctuation">.</span><span class="token function">GetPolicyAsync</span><span class="token punctuation">(</span>policyName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>注意</strong>：自定义的 <code>TestAuthorizationPolicyProvider</code> 必须实现 <code>IAuthorizationPolicyProvider</code>，否则添加到 DI 时会不生效。</p> <p>在 Program.cs 中，将自定义的 PolicyProvider 添加到 DI 中：</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>builder<span class="token punctuation">.</span>Services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddSingleton</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IAuthorizationPolicyProvider<span class="token punctuation">,</span> TestAuthorizationPolicyProvider<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>注意</strong>：只会生效最后一个添加的 PolicyProvider。</p> <h4 id="_3-4-8-补充-自定义-authorizationmiddleware"><a href="#_3-4-8-补充-自定义-authorizationmiddleware" class="header-anchor">#</a> 3.4.8 补充：自定义 AuthorizationMiddleware</h4> <p>自定义 AuthorizationMiddleware 可以：</p> <ul><li>返回自定义的响应</li> <li>增强（或者说改变）默认的 challenge 或 forbid 响应</li></ul> <p>具体请查看官方文档<a href="https://docs.microsoft.com/zh-cn/aspnet/core/security/authorization/customizingauthorizationmiddlewareresponse?view=aspnetcore-6.0" target="_blank" rel="noopener noreferrer">自定义 AuthorizationMiddleware 的行为<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h4 id="_3-4-9-补充-基于资源的授权"><a href="#_3-4-9-补充-基于资源的授权" class="header-anchor">#</a> 3.4.9 补充：基于资源的授权</h4> <p>具体请查看官方文档<a href="https://docs.microsoft.com/zh-cn/aspnet/core/security/authorization/resourcebased?view=aspnetcore-6.0" target="_blank" rel="noopener noreferrer">基于资源的授权<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h4 id="_3-4-10-补充-miniapi-的授权"><a href="#_3-4-10-补充-miniapi-的授权" class="header-anchor">#</a> 3.4.10 补充：MiniApi 的授权</h4> <p>在 MiniApi 中几乎都是形如 MapGet() 的分支节点，这类终结点无法使用 [Authorize] 标签，可以用使用 RequireAuthorization(&quot;Something&quot;) 进行授权，如：</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>app<span class="token punctuation">.</span><span class="token function">MapGet</span><span class="token punctuation">(</span><span class="token string">&quot;/helloworld&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token string">&quot;Hello World!&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">RequireAuthorization</span><span class="token punctuation">(</span><span class="token string">&quot;AtLeast21&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_3-5-授权过程"><a href="#_3-5-授权过程" class="header-anchor">#</a> 3.5 授权过程</h3> <p>建议看一下<a href="https://www.cnblogs.com/RainingNight/p/authorize-how-to-work-in-asp-net-core.html#iauthorizationservice" target="_blank" rel="noopener noreferrer">ASP.NET Core 认证与授权6:授权策略是怎么执行的？<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>这篇文章，文章将授权相关的源码整理出来了，并说明了其中的关系。</p> <p>与授权相关的 interface 和 class 如下：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>IAuthorizationService <span class="token comment">#验证授权的服务，主要方法AuthorizeAsync</span>
DefaultAuthorizationService <span class="token comment">#IAuthorizationService的默认实现</span>
IAuthorizationHandler <span class="token comment">#负责检查是否满足要求，主要方法HandleAsync</span>
IAuthorizationRequirement <span class="token comment">#只有属性，没有方法；用于标记服务，以及用于追踪授权是否成功的机制。</span>
AuthorizationHandler<span class="token operator">&lt;</span>TRequirement<span class="token operator">&gt;</span> <span class="token comment">#主要方法HandleRequirementAsync</span>
</code></pre></div><p>这里简述一下其关系：</p> <p><code>[Authorize]</code> 标签生效时，调用的是 <code>IAuthorizationService</code> 的 <code>AuthorizeAsync</code>（由 <code>DefaultAuthorizationService</code> 实现）。</p> <p><code>AuthorizeAsync</code> 会去调用所有 <code>IAuthorizationHandler</code> 的 <code>HandleAsync</code> （由 <code>AuthorizationHandler&lt;TRequirement&gt;</code> 实现）。</p> <p><code>HandleAsync</code> 会去调用 <code>AuthorizationHandler&lt;TRequirement&gt;</code>  的<code>HandleRequirementAsync</code> 的方法。</p> <p><strong>注意</strong>：这里只是列出了主要的接口和类，部分没有列出，如：<code>IAuthorizationHandlerProvider</code>（这个接口的默认实现 <code>DefaultAuthorizationHandlerProvider</code>，主要是用于收集 <code>IAuthorizationHandler</code> 并返回 <code>IEnumerable&lt;IAuthorizationHandler&gt;</code>）</p> <h2 id="_4-源码"><a href="#_4-源码" class="header-anchor">#</a> 4 源码</h2> <p>Gitee：https://gitee.com/lisheng741/testnetcore/tree/master/Security/AuthenticationTest</p> <p>Github：https://github.com/lisheng741/testnetcore/tree/master/Security/AuthenticationTest</p> <h2 id="参考来源"><a href="#参考来源" class="header-anchor">#</a> 参考来源</h2> <p>ASP.NET Core 6.0 官方文档：<a href="https://docs.microsoft.com/zh-cn/aspnet/core/security/authorization/iauthorizationpolicyprovider?view=aspnetcore-6.0" target="_blank" rel="noopener noreferrer">授权策略提供程序<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://www.dongchuanmin.com/archives/738.html" target="_blank" rel="noopener noreferrer">.NET 6 使用JWT Bearer认证和授权的步骤<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://www.cnblogs.com/RainingNight/p/authorize-how-to-work-in-asp-net-core.html#iauthorizationservice" target="_blank" rel="noopener noreferrer">ASP.NET Core 认证与授权6:授权策略是怎么执行的？<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>（mark：这篇很强！）</p> <p><a href="https://www.cnblogs.com/RainingNight/p/dynamic-authorization-in-asp-net-core.html" target="_blank" rel="noopener noreferrer">ASP.NET Core 认证与授权7:动态授权<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/lisheng741/blog/edit/master/docs/backend/ASP.NETCore添加JWT.md" target="_blank" rel="noopener noreferrer">在 GitHub 上编辑此页</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2022/4/21 22:45:38</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/backend/EFCore关联查询.html" class="prev">
        EF Core 的关联查询
      </a></span> <span class="next"><a href="/blog/backend/ASP.NETCore模型验证.html">
        ASP.NET Core 6.0 基于模型验证的数据验证
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/blog/assets/js/app.558beeb7.js" defer></script><script src="/blog/assets/js/2.c9b070a5.js" defer></script><script src="/blog/assets/js/23.1e210814.js" defer></script>
  </body>
</html>
