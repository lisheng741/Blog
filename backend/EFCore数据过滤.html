<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>EF Core 数据过滤 | 芦荟柚子茶的博客</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="cl_lis blog">
    
    <link rel="preload" href="/blog/assets/css/0.styles.0b1ac558.css" as="style"><link rel="preload" href="/blog/assets/js/app.558beeb7.js" as="script"><link rel="preload" href="/blog/assets/js/2.c9b070a5.js" as="script"><link rel="preload" href="/blog/assets/js/25.69362e2a.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.ab0a2d87.js"><link rel="prefetch" href="/blog/assets/js/11.0cc953f3.js"><link rel="prefetch" href="/blog/assets/js/12.366feb7b.js"><link rel="prefetch" href="/blog/assets/js/13.c133c64c.js"><link rel="prefetch" href="/blog/assets/js/14.80cd9f46.js"><link rel="prefetch" href="/blog/assets/js/15.db67f680.js"><link rel="prefetch" href="/blog/assets/js/16.a3cc2600.js"><link rel="prefetch" href="/blog/assets/js/17.30a20293.js"><link rel="prefetch" href="/blog/assets/js/18.abaa7e33.js"><link rel="prefetch" href="/blog/assets/js/19.c5dd4582.js"><link rel="prefetch" href="/blog/assets/js/20.3ee32d4a.js"><link rel="prefetch" href="/blog/assets/js/21.d7df4dff.js"><link rel="prefetch" href="/blog/assets/js/22.3cfc9a6c.js"><link rel="prefetch" href="/blog/assets/js/23.1e210814.js"><link rel="prefetch" href="/blog/assets/js/24.7f724dd0.js"><link rel="prefetch" href="/blog/assets/js/26.7efec979.js"><link rel="prefetch" href="/blog/assets/js/27.baab02b4.js"><link rel="prefetch" href="/blog/assets/js/28.22708483.js"><link rel="prefetch" href="/blog/assets/js/29.8131a205.js"><link rel="prefetch" href="/blog/assets/js/3.91f35203.js"><link rel="prefetch" href="/blog/assets/js/30.1dcc6d5c.js"><link rel="prefetch" href="/blog/assets/js/31.cd647998.js"><link rel="prefetch" href="/blog/assets/js/32.f22a6677.js"><link rel="prefetch" href="/blog/assets/js/33.031d81c8.js"><link rel="prefetch" href="/blog/assets/js/34.dc2b0687.js"><link rel="prefetch" href="/blog/assets/js/35.55225650.js"><link rel="prefetch" href="/blog/assets/js/36.01a82d7c.js"><link rel="prefetch" href="/blog/assets/js/37.9e6b4b86.js"><link rel="prefetch" href="/blog/assets/js/38.947002a2.js"><link rel="prefetch" href="/blog/assets/js/39.d252a4d8.js"><link rel="prefetch" href="/blog/assets/js/4.d2bc884a.js"><link rel="prefetch" href="/blog/assets/js/5.8deafdd4.js"><link rel="prefetch" href="/blog/assets/js/6.b88d790a.js"><link rel="prefetch" href="/blog/assets/js/7.5a873c47.js"><link rel="prefetch" href="/blog/assets/js/8.b3ddc9f5.js"><link rel="prefetch" href="/blog/assets/js/9.45271a8d.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.0b1ac558.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">芦荟柚子茶的博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/blog/projects/" class="nav-link">
  项目
</a></div><div class="nav-item"><a href="/blog/record/" class="nav-link">
  记录
</a></div><div class="nav-item"><a href="/blog/fronted/" class="nav-link">
  前端
</a></div><div class="nav-item"><a href="/blog/backend/" class="nav-link router-link-active">
  后端
</a></div><div class="nav-item"><a href="/blog/thanks/" class="nav-link">
  感谢
</a></div> <a href="https://github.com/lisheng741/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/blog/projects/" class="nav-link">
  项目
</a></div><div class="nav-item"><a href="/blog/record/" class="nav-link">
  记录
</a></div><div class="nav-item"><a href="/blog/fronted/" class="nav-link">
  前端
</a></div><div class="nav-item"><a href="/blog/backend/" class="nav-link router-link-active">
  后端
</a></div><div class="nav-item"><a href="/blog/thanks/" class="nav-link">
  感谢
</a></div> <a href="https://github.com/lisheng741/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>后端</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/backend/" aria-current="page" class="sidebar-link">目录</a></li><li><a href="/blog/backend/EFCore配置模型.html" class="sidebar-link">EF Core 配置模型</a></li><li><a href="/blog/backend/EFCore的DbFirst模式.html" class="sidebar-link">EFCore 的 DbFirst 模式</a></li><li><a href="/blog/backend/EFCore的CodeFirst模式.html" class="sidebar-link">EF Core 的 Code First 模式</a></li><li><a href="/blog/backend/EFCore概述.html" class="sidebar-link">EF Core 概述</a></li><li><a href="/blog/backend/EFCore数据过滤.html" class="active sidebar-link">EF Core 数据过滤</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/backend/EFCore数据过滤.html#_1-前言" class="sidebar-link">1 前言</a></li><li class="sidebar-sub-header"><a href="/blog/backend/EFCore数据过滤.html#_2-ef-core-查询筛选器" class="sidebar-link">2 EF Core 查询筛选器</a></li><li class="sidebar-sub-header"><a href="/blog/backend/EFCore数据过滤.html#_3-自定义数据过滤" class="sidebar-link">3 自定义数据过滤</a></li><li class="sidebar-sub-header"><a href="/blog/backend/EFCore数据过滤.html#_4-完整代码" class="sidebar-link">4 完整代码</a></li><li class="sidebar-sub-header"><a href="/blog/backend/EFCore数据过滤.html#参考来源" class="sidebar-link">参考来源</a></li></ul></li><li><a href="/blog/backend/EFCore关联查询.html" class="sidebar-link">EF Core 的关联查询</a></li><li><a href="/blog/backend/ASP.NETCore添加JWT.html" class="sidebar-link">ASP.NET Core 6.0 添加 JWT 认证和授权</a></li><li><a href="/blog/backend/ASP.NETCore模型验证.html" class="sidebar-link">ASP.NET Core 6.0 基于模型验证的数据验证</a></li><li><a href="/blog/backend/ASP.NETCore开启CORS.html" class="sidebar-link">ASP.NET Core 6.0 开启 CORS 跨域请求</a></li><li><a href="/blog/backend/ASP.NETCore定时任务Quartz.html" class="sidebar-link">ASP.NET Core 6.0 定时任务 Quartz</a></li><li><a href="/blog/backend/ASP.NETCore关于CSRedis.html" class="sidebar-link">ASP.NET Core 关于 CSRedis</a></li><li><a href="/blog/backend/ASP.NETCore关于Cache.html" class="sidebar-link">ASP.NET Core 6.0 关于 Cache</a></li><li><a href="/blog/backend/ASP.NETCore关于Autofac使用.html" class="sidebar-link">ASP.NET Core 6.0 关于 Autofac 使用</a></li><li><a href="/blog/backend/ASP.NETCore使用AutoMapper.html" class="sidebar-link">ASP.NET Core 6.0 使用 AutoMapper</a></li><li><a href="/blog/backend/ASP.NETCore产生连续Guid.html" class="sidebar-link">ASP.NET Core 产生连续 Guid</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="ef-core-数据过滤"><a href="#ef-core-数据过滤" class="header-anchor">#</a> EF Core 数据过滤</h1> <h2 id="_1-前言"><a href="#_1-前言" class="header-anchor">#</a> 1 前言</h2> <p>本文致力于将一种<strong>动态数据过滤</strong>的方案描述出来（基于 EF Core 官方的数据筛选器），实现自动注册，多个条件过滤，单条件禁用（实际上是参考ABP的源码），并尽量让代码保持 EF Core 的原使用风格。</p> <h3 id="_1-1-本文的脉络"><a href="#_1-1-本文的脉络" class="header-anchor">#</a> 1.1 本文的脉络</h3> <p>会在一开始，讲述数据过滤的场景以及基本的实现思路。</p> <p>随后列出 EF Core 官方的数据查询筛选器例子。</p> <p>最后将笔者的方案按功能（自动注册，多个条件过滤，单条件禁用）逐一实现出来。</p> <h3 id="_1-2-数据过滤的场景"><a href="#_1-2-数据过滤的场景" class="header-anchor">#</a> 1.2 数据过滤的场景</h3> <p>一般我们会有这样的场景，可能需要数据过滤：</p> <ul><li>软删</li> <li>多租户</li> <li>通用数据权限（数据过滤）</li></ul> <p>如软删，我们一般会希望，我们查询出来的数据，是过滤掉被删除数据的，可能我们会这样写：</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token class-name"><span class="token keyword">var</span></span> users <span class="token operator">=</span> db<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span>u <span class="token operator">=&gt;</span> <span class="token operator">!</span>u<span class="token punctuation">.</span>IsDeleted<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>但是如果数据过滤全靠人工编写，那会是一件很烦的事，有时候甚至会忘记写。而且如果以后发生了什么需求变化，需要修改数据过滤的代码，到时候是到处修改，也是很烦的一件事。</p> <p>如果能把数据过滤统一管理起来，这样不但不用重复无意义的工作，而且以后需要修改的时候，改一处地方即可。</p> <h2 id="_2-ef-core-查询筛选器"><a href="#_2-ef-core-查询筛选器" class="header-anchor">#</a> 2 EF Core 查询筛选器</h2> <h3 id="_2-1-介绍"><a href="#_2-1-介绍" class="header-anchor">#</a> 2.1 介绍</h3> <p>EF Core 官方提供的查询筛选器（Query Filter）能满足我们过滤数据的基本需求，下面介绍一下这种筛选器。</p> <p>EF Core 官方的查询筛选器，是在 DbContext 的 OnModelCreating 中定义的，且每个实体只能拥有一个筛选器（如定义了多个筛选器，则只会生效最后一个）。</p> <p>筛选器默认是启用的，如要禁用，需要在查询过程中使用 IgnoreQueryFilters 方法，如：</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token class-name"><span class="token keyword">var</span></span> users <span class="token operator">=</span> db<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token function">IgnoreQueryFilters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_2-2-基本使用"><a href="#_2-2-基本使用" class="header-anchor">#</a> 2.2 基本使用</h3> <p>具体可以自行翻查官方文档：<a href="https://docs.microsoft.com/zh-cn/ef/core/querying/filters" target="_blank" rel="noopener noreferrer">全局查询筛选器<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h4 id="_1-定义带有软删字段的实体"><a href="#_1-定义带有软删字段的实体" class="header-anchor">#</a> （1）定义带有软删字段的实体</h4> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestDelete</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> Id <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span><span class="token punctuation">?</span></span> Name <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> IsDeleted <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_2-注册筛选器"><a href="#_2-注册筛选器" class="header-anchor">#</a> （2）注册筛选器</h4> <p>使用 <code>HasQueryFilter</code> API 在 <code>OnModelCreating</code> 中配置查询筛选器。</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">protected</span> <span class="token keyword">override</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnModelCreating</span><span class="token punctuation">(</span><span class="token class-name">ModelBuilder</span> builder<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    builder<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Entity</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TestDelete<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">HasQueryFilter</span><span class="token punctuation">(</span>e <span class="token operator">=&gt;</span> <span class="token operator">!</span>e<span class="token punctuation">.</span>IsDeleted<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_3-查询中使用"><a href="#_3-查询中使用" class="header-anchor">#</a> （3）查询中使用</h4> <p>直接查询：</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token class-name"><span class="token keyword">var</span></span> deletes <span class="token operator">=</span> _context<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Set</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TestDelete<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>将生成如下SQL：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token punctuation">[</span>t<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>Id<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>t<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>IsDeleted<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>t<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>Name<span class="token punctuation">]</span>
<span class="token keyword">FROM</span> <span class="token punctuation">[</span>TestDelete<span class="token punctuation">]</span> <span class="token keyword">AS</span> <span class="token punctuation">[</span>t<span class="token punctuation">]</span>
<span class="token keyword">WHERE</span> <span class="token punctuation">[</span>t<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>IsDeleted<span class="token punctuation">]</span> <span class="token operator">=</span> CAST<span class="token punctuation">(</span><span class="token number">0</span> <span class="token keyword">AS</span> <span class="token keyword">bit</span><span class="token punctuation">)</span>
</code></pre></div><p>查询结果将会过滤掉已删除的数据。</p> <h4 id="_4-禁用筛选器"><a href="#_4-禁用筛选器" class="header-anchor">#</a> （4）禁用筛选器</h4> <p>使用 <code>IgnoreQueryFilters</code> API 禁用筛选器：</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token class-name"><span class="token keyword">var</span></span> deletes <span class="token operator">=</span> _context<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Set</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TestDelete<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token function">IgnoreQueryFilters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>将生成如下SQL：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token punctuation">[</span>t<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>Id<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>t<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>IsDeleted<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>t<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>Name<span class="token punctuation">]</span>
<span class="token keyword">FROM</span> <span class="token punctuation">[</span>TestDelete<span class="token punctuation">]</span> <span class="token keyword">AS</span> <span class="token punctuation">[</span>t<span class="token punctuation">]</span>
</code></pre></div><p>将不会过滤数据。</p> <h3 id="_2-3-限制"><a href="#_2-3-限制" class="header-anchor">#</a> 2.3 限制</h3> <p>EF Core 查询筛选器的限制很明显：</p> <ul><li>只能生效最后一个</li> <li>一旦禁用，将禁用所有过滤条件</li></ul> <p>只能生效最后一个这个，可以通过拼凑多个条件的 Expression 来解决。</p> <p>禁用过滤器这个，只能通过特定的手段来实现单个条件的禁用了。</p> <h2 id="_3-自定义数据过滤"><a href="#_3-自定义数据过滤" class="header-anchor">#</a> 3 自定义数据过滤</h2> <h3 id="_3-1-目标"><a href="#_3-1-目标" class="header-anchor">#</a> 3.1 目标</h3> <p>将实现这些功能：</p> <ul><li><p>自动注册实体、筛选器等</p></li> <li><p>多个条件过滤</p></li> <li><p>单条件禁用</p></li></ul> <h3 id="_3-2-自动注册实体"><a href="#_3-2-自动注册实体" class="header-anchor">#</a> 3.2 自动注册实体</h3> <p>完成这个功能以后，将不需要自己一个一个去注册实体，不需要重复以下这句代码：</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>builder<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Entity</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TestDelete<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="_1-基础实体准备"><a href="#_1-基础实体准备" class="header-anchor">#</a> （1）基础实体准备</h4> <p>准备一个 EntityBase 作为所有实体的父类，所有继承该类的非 abstract 类都将被注册为实体。</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">EntityBase</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">EntityBase<span class="token punctuation">&lt;</span>TKey<span class="token punctuation">&gt;</span></span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">EntityBase</span></span>
    <span class="token keyword">where</span> <span class="token class-name">TKey</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token keyword">struct</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">TKey</span> Id <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_2-自动注册实体实现"><a href="#_2-自动注册实体实现" class="header-anchor">#</a> （2）自动注册实体实现</h4> <p>笔者自定义的 DbContext 名为 EDbContext，下面将多次使用到这个上下文。</p> <p>在 <code>OnModelCreating</code> 中编写如下代码：</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token comment">// 获取程序集</span>
<span class="token class-name">Assembly</span> assembly <span class="token operator">=</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">EDbContext</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Assembly<span class="token punctuation">;</span>
<span class="token comment">// 获取所有继承自 EntityBase 的非 abstract 类</span>
<span class="token class-name">List<span class="token punctuation">&lt;</span>Type<span class="token punctuation">&gt;</span></span> entityTypes <span class="token operator">=</span> assembly<span class="token punctuation">.</span><span class="token function">GetTypes</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span>t <span class="token operator">=&gt;</span> t<span class="token punctuation">.</span><span class="token function">IsSubclassOf</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">EntityBase</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>t<span class="token punctuation">.</span>IsAbstract<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">ToList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 注册实体</span>
<span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token class-name">Type</span> entityType <span class="token keyword">in</span> entityTypes<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    builder<span class="token punctuation">.</span><span class="token function">Entity</span><span class="token punctuation">(</span>entityType<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_3-3-自定注册筛选器"><a href="#_3-3-自定注册筛选器" class="header-anchor">#</a> 3.3 自定注册筛选器</h3> <p>完成这个功能以后，将不需要自己一个一个去注册一些筛选器，如：不需要重复以下这句代码：</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>builder<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Entity</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TestDelete<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">HasQueryFilter</span><span class="token punctuation">(</span>e <span class="token operator">=&gt;</span> <span class="token operator">!</span>e<span class="token punctuation">.</span>IsDeleted<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="_1-基础实体准备-2"><a href="#_1-基础实体准备-2" class="header-anchor">#</a> （1）基础实体准备</h4> <p>定义一个软删的 interface，所有需要软删功能的实体，都去实现这个接口：</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token comment">// 定义软删接口</span>
<span class="token keyword">interface</span> <span class="token class-name">ISoftDelete</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> IsDeleted <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// TestDelete 相应修改为</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestDelete</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">EntityBase<span class="token punctuation">&lt;</span><span class="token keyword">int</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name">ISoftDelete</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span><span class="token punctuation">?</span></span> Name <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> IsDeleted <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_2-自动注册实现"><a href="#_2-自动注册实现" class="header-anchor">#</a> （2）自动注册实现</h4> <p>EDbContext 的代码变为如下（增加了一个 <code>ConfigureFilters</code> 方法）：</p> <p>因为 <code>ConfigureFilters</code> 是一个泛型方法，需要做一些特殊处理。</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">protected</span> <span class="token keyword">override</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnModelCreating</span><span class="token punctuation">(</span><span class="token class-name">ModelBuilder</span> builder<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name">Assembly</span> assembly <span class="token operator">=</span> Assembly<span class="token punctuation">.</span><span class="token function">GetExecutingAssembly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List<span class="token punctuation">&lt;</span>Type<span class="token punctuation">&gt;</span></span> entityTypes <span class="token operator">=</span> assembly<span class="token punctuation">.</span><span class="token function">GetTypes</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span>t <span class="token operator">=&gt;</span> t<span class="token punctuation">.</span><span class="token function">IsSubclassOf</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">EntityBase</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>t<span class="token punctuation">.</span>IsAbstract<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">ToList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 特殊处理：获取 ConfigureFilters</span>
    <span class="token class-name">MethodInfo<span class="token punctuation">?</span></span> configureFilters <span class="token operator">=</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">EDbContext</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetMethod</span><span class="token punctuation">(</span>
        <span class="token keyword">nameof</span><span class="token punctuation">(</span>ConfigureFilters<span class="token punctuation">)</span><span class="token punctuation">,</span>
        BindingFlags<span class="token punctuation">.</span>Instance <span class="token operator">|</span> BindingFlags<span class="token punctuation">.</span>NonPublic
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>configureFilters <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ArgumentNullException</span><span class="token punctuation">(</span><span class="token keyword">nameof</span><span class="token punctuation">(</span>configureFilters<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token class-name">Type</span> entityType <span class="token keyword">in</span> entityTypes<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        builder<span class="token punctuation">.</span><span class="token function">Entity</span><span class="token punctuation">(</span>entityType<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 如果实体实现了 ISoftDelete 接口，则自动注册软删筛选器</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">ISoftDelete</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">IsAssignableFrom</span><span class="token punctuation">(</span>entityType<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token comment">// 特殊处理：调用 ConfigureFilters</span>
            configureFilters
                <span class="token punctuation">.</span><span class="token function">MakeGenericMethod</span><span class="token punctuation">(</span>entityType<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">Invoke</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">object</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> <span class="token punctuation">{</span> builder <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 自定义配置筛选器方法</span>
<span class="token keyword">protected</span> <span class="token keyword">virtual</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token generic-method"><span class="token function">ConfigureFilters</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TEntity<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">ModelBuilder</span> builder<span class="token punctuation">)</span>
    <span class="token keyword">where</span> <span class="token class-name">TEntity</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token keyword">class</span></span>
<span class="token punctuation">{</span>
    <span class="token class-name">Expression<span class="token punctuation">&lt;</span>Func<span class="token punctuation">&lt;</span>TEntity<span class="token punctuation">,</span> <span class="token keyword">bool</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> expression <span class="token operator">=</span> e <span class="token operator">=&gt;</span> <span class="token operator">!</span>EF<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Property</span><span class="token generic class-name"><span class="token punctuation">&lt;</span><span class="token keyword">bool</span><span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> <span class="token string">&quot;IsDeleted&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    builder<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Entity</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TEntity<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">HasQueryFilter</span><span class="token punctuation">(</span>expression<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_3-测试-自动注册功能的测试"><a href="#_3-测试-自动注册功能的测试" class="header-anchor">#</a> （3） 测试：自动注册功能的测试</h4> <p>完成自动注册以后，运行程序，看看过滤器是否有效果：</p> <p>直接查询：</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token class-name"><span class="token keyword">var</span></span> deletes <span class="token operator">=</span> _context<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Set</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TestDelete<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>将生成如下SQL：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token punctuation">[</span>t<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>Id<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>t<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>IsDeleted<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>t<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>Name<span class="token punctuation">]</span>
<span class="token keyword">FROM</span> <span class="token punctuation">[</span>TestDelete<span class="token punctuation">]</span> <span class="token keyword">AS</span> <span class="token punctuation">[</span>t<span class="token punctuation">]</span>
<span class="token keyword">WHERE</span> <span class="token punctuation">[</span>t<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>IsDeleted<span class="token punctuation">]</span> <span class="token operator">=</span> CAST<span class="token punctuation">(</span><span class="token number">0</span> <span class="token keyword">AS</span> <span class="token keyword">bit</span><span class="token punctuation">)</span>
</code></pre></div><p>查询结果将会过滤掉已删除的数据。</p> <p>可以看到，自动注册是成功的！</p> <h3 id="_3-4-实现-多个条件过滤"><a href="#_3-4-实现-多个条件过滤" class="header-anchor">#</a> 3.4 实现：多个条件过滤</h3> <p>在这一小节中，将会实现多个条件过滤。</p> <p>一般我们的程序中，除了软删，还可能有其他的需要统一管理的数据过滤，如：多租户。</p> <h4 id="_1-基础实体准备-3"><a href="#_1-基础实体准备-3" class="header-anchor">#</a> （1）基础实体准备</h4> <p>准备一个多租户的 interface，命名为 ITenant，所有需要多租户控制的，都实现该接口。</p> <p>并准备一个 TestTenant 同时实现 ITenant 和 ISoftDelete。</p> <p>为简单处理，将 TenantId 默认值设置为 1</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token comment">// 多租户接口</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ITenant</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> TenantId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestTenant</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">EntityBase<span class="token punctuation">&lt;</span><span class="token keyword">int</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name">ITenant</span><span class="token punctuation">,</span> <span class="token class-name">ISoftDelete</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span><span class="token punctuation">?</span></span> Name <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> TenantId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> IsDeleted <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_2-合并表达式树代码准备"><a href="#_2-合并表达式树代码准备" class="header-anchor">#</a> （2）合并表达式树代码准备</h4> <p>因为涉及到两个表达式树（Expression）的合并，这里准备了合并的代码（摘自ABP框架），放在 EDbContext 中即可：</p> <p>关于表达式树，个人也是不会，就不在这里误人子弟啦。</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">protected</span> <span class="token keyword">virtual</span> <span class="token return-type class-name">Expression<span class="token punctuation">&lt;</span>Func<span class="token punctuation">&lt;</span>T<span class="token punctuation">,</span> <span class="token keyword">bool</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">CombineExpressions</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">Expression<span class="token punctuation">&lt;</span>Func<span class="token punctuation">&lt;</span>T<span class="token punctuation">,</span> <span class="token keyword">bool</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> expression1<span class="token punctuation">,</span> <span class="token class-name">Expression<span class="token punctuation">&lt;</span>Func<span class="token punctuation">&lt;</span>T<span class="token punctuation">,</span> <span class="token keyword">bool</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> expression2<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name"><span class="token keyword">var</span></span> parameter <span class="token operator">=</span> Expression<span class="token punctuation">.</span><span class="token function">Parameter</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">T</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name"><span class="token keyword">var</span></span> leftVisitor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ReplaceExpressionVisitor</span><span class="token punctuation">(</span>expression1<span class="token punctuation">.</span>Parameters<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> parameter<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> left <span class="token operator">=</span> leftVisitor<span class="token punctuation">.</span><span class="token function">Visit</span><span class="token punctuation">(</span>expression1<span class="token punctuation">.</span>Body<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name"><span class="token keyword">var</span></span> rightVisitor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ReplaceExpressionVisitor</span><span class="token punctuation">(</span>expression2<span class="token punctuation">.</span>Parameters<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> parameter<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> right <span class="token operator">=</span> rightVisitor<span class="token punctuation">.</span><span class="token function">Visit</span><span class="token punctuation">(</span>expression2<span class="token punctuation">.</span>Body<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> Expression<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Lambda</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Func<span class="token punctuation">&lt;</span>T<span class="token punctuation">,</span> <span class="token keyword">bool</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>Expression<span class="token punctuation">.</span><span class="token function">AndAlso</span><span class="token punctuation">(</span>left<span class="token punctuation">,</span> right<span class="token punctuation">)</span><span class="token punctuation">,</span> parameter<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">ReplaceExpressionVisitor</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">ExpressionVisitor</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">Expression</span> _oldValue<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">Expression</span> _newValue<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">ReplaceExpressionVisitor</span><span class="token punctuation">(</span><span class="token class-name">Expression</span> oldValue<span class="token punctuation">,</span> <span class="token class-name">Expression</span> newValue<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _oldValue <span class="token operator">=</span> oldValue<span class="token punctuation">;</span>
        _newValue <span class="token operator">=</span> newValue<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token return-type class-name">Expression</span> <span class="token function">Visit</span><span class="token punctuation">(</span><span class="token class-name">Expression<span class="token punctuation">?</span></span> node<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token operator">==</span> _oldValue<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">return</span> _newValue<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token keyword">base</span><span class="token punctuation">.</span><span class="token function">Visit</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token operator">!</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_3-实现多个条件过滤"><a href="#_3-实现多个条件过滤" class="header-anchor">#</a> （3）实现多个条件过滤</h4> <p>EDbContext 的代码变为如下：</p> <p>修改了 <code>OnModelCreating</code> 和 <code>ConfigureFilters</code> 的大部分代码：</p> <p>注：为简单处理，租户的过滤条件设置为 TenantId == 1</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">protected</span> <span class="token keyword">override</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnModelCreating</span><span class="token punctuation">(</span><span class="token class-name">ModelBuilder</span> builder<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name">Assembly</span> assembly <span class="token operator">=</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">EDbContext</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Assembly<span class="token punctuation">;</span>
    <span class="token class-name">List<span class="token punctuation">&lt;</span>Type<span class="token punctuation">&gt;</span></span> entityTypes <span class="token operator">=</span> assembly<span class="token punctuation">.</span><span class="token function">GetTypes</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span>t <span class="token operator">=&gt;</span> t<span class="token punctuation">.</span><span class="token function">IsSubclassOf</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">EntityBase</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>t<span class="token punctuation">.</span>IsAbstract<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">ToList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">MethodInfo<span class="token punctuation">?</span></span> configureFilters <span class="token operator">=</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">EDbContext</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetMethod</span><span class="token punctuation">(</span>
        <span class="token keyword">nameof</span><span class="token punctuation">(</span>ConfigureFilters<span class="token punctuation">)</span><span class="token punctuation">,</span>
        BindingFlags<span class="token punctuation">.</span>Instance <span class="token operator">|</span> BindingFlags<span class="token punctuation">.</span>NonPublic
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>configureFilters <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ArgumentNullException</span><span class="token punctuation">(</span><span class="token keyword">nameof</span><span class="token punctuation">(</span>configureFilters<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token class-name">Type</span> entityType <span class="token keyword">in</span> entityTypes<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// 注册实体</span>
        builder<span class="token punctuation">.</span><span class="token function">Entity</span><span class="token punctuation">(</span>entityType<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 注册筛选器</span>
        configureFilters
            <span class="token punctuation">.</span><span class="token function">MakeGenericMethod</span><span class="token punctuation">(</span>entityType<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">Invoke</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">object</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> <span class="token punctuation">{</span> builder<span class="token punctuation">,</span> entityType <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">protected</span> <span class="token keyword">virtual</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token generic-method"><span class="token function">ConfigureFilters</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TEntity<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">ModelBuilder</span> builder<span class="token punctuation">,</span> <span class="token class-name">Type</span> entityType<span class="token punctuation">)</span>
	<span class="token keyword">where</span> <span class="token class-name">TEntity</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token keyword">class</span></span>
<span class="token punctuation">{</span>
    <span class="token class-name">Expression<span class="token punctuation">&lt;</span>Func<span class="token punctuation">&lt;</span>TEntity<span class="token punctuation">,</span> <span class="token keyword">bool</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span><span class="token punctuation">?</span></span> expression <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">ISoftDelete</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">IsAssignableFrom</span><span class="token punctuation">(</span>entityType<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        expression <span class="token operator">=</span> e <span class="token operator">=&gt;</span> <span class="token operator">!</span>EF<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Property</span><span class="token generic class-name"><span class="token punctuation">&lt;</span><span class="token keyword">bool</span><span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> <span class="token string">&quot;IsDeleted&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">ITenant</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">IsAssignableFrom</span><span class="token punctuation">(</span>entityType<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name">Expression<span class="token punctuation">&lt;</span>Func<span class="token punctuation">&lt;</span>TEntity<span class="token punctuation">,</span> <span class="token keyword">bool</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> tenantExpression <span class="token operator">=</span> e <span class="token operator">=&gt;</span> EF<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Property</span><span class="token generic class-name"><span class="token punctuation">&lt;</span><span class="token keyword">int</span><span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> <span class="token string">&quot;TenantId&quot;</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">;</span>
        expression <span class="token operator">=</span> expression <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token punctuation">?</span> tenantExpression <span class="token punctuation">:</span> <span class="token function">CombineExpressions</span><span class="token punctuation">(</span>expression<span class="token punctuation">,</span> tenantExpression<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>expression <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

    builder<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Entity</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TEntity<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">HasQueryFilter</span><span class="token punctuation">(</span>expression<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_4-测试-多条件过滤"><a href="#_4-测试-多条件过滤" class="header-anchor">#</a> （4）测试：多条件过滤</h4> <p>直接查询：</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token class-name"><span class="token keyword">var</span></span> tenants <span class="token operator">=</span> _context<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Set</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TestTenant<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>将生成如下SQL：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token punctuation">[</span>t<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>Id<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>t<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>IsDeleted<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>t<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>Name<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>t<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>TenantId<span class="token punctuation">]</span>
<span class="token keyword">FROM</span> <span class="token punctuation">[</span>TestTenant<span class="token punctuation">]</span> <span class="token keyword">AS</span> <span class="token punctuation">[</span>t<span class="token punctuation">]</span>
<span class="token keyword">WHERE</span> <span class="token punctuation">(</span><span class="token punctuation">[</span>t<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>IsDeleted<span class="token punctuation">]</span> <span class="token operator">=</span> CAST<span class="token punctuation">(</span><span class="token number">0</span> <span class="token keyword">AS</span> <span class="token keyword">bit</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">AND</span> <span class="token punctuation">(</span><span class="token punctuation">[</span>t<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>TenantId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span>
</code></pre></div><p>查询结果将会过滤掉已删除，且租户Id=1的数据。</p> <h3 id="_3-5-实现-单条件禁用"><a href="#_3-5-实现-单条件禁用" class="header-anchor">#</a> 3.5 实现：单条件禁用</h3> <p>直接使用 <code>IgnoreQueryFilters</code> 将会禁用筛选器，这里希望有个控制，可以单个条件控制：</p> <p>下面实现禁用软删筛选器：</p> <h4 id="_1-dbcontext-变量控制"><a href="#_1-dbcontext-变量控制" class="header-anchor">#</a> （1）DbContext 变量控制</h4> <p>在 EDbContext 中新增一个属性：</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EDbContext</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">DbContext</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> IgnoreDeleteFilter <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 其他代码忽略</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_2-修改筛选器"><a href="#_2-修改筛选器" class="header-anchor">#</a> （2）修改筛选器</h4> <p>修改了 <code>ConfigureFilters</code> 的代码：</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">ISoftDelete</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">IsAssignableFrom</span><span class="token punctuation">(</span>entityType<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 如果 IgnoreDeleteFilter 为 true，将跳过</span>
    expression <span class="token operator">=</span> e <span class="token operator">=&gt;</span> IgnoreDeleteFilter <span class="token operator">||</span> <span class="token operator">!</span>EF<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Property</span><span class="token generic class-name"><span class="token punctuation">&lt;</span><span class="token keyword">bool</span><span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> <span class="token string">&quot;IsDeleted&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_3-测试-单条件禁用"><a href="#_3-测试-单条件禁用" class="header-anchor">#</a> （3）测试：单条件禁用</h4> <p>测试语句如下：</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>_context<span class="token punctuation">.</span>IgnoreDeleteFilter <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token class-name"><span class="token keyword">var</span></span> tenants <span class="token operator">=</span> _context<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Set</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TestTenant<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>生成如下SQL：</p> <div class="language-sql extra-class"><pre class="language-sql"><code>Executed DbCommand <span class="token punctuation">(</span><span class="token number">1</span>ms<span class="token punctuation">)</span> <span class="token punctuation">[</span>Parameters<span class="token operator">=</span><span class="token punctuation">[</span><span class="token variable">@__ef_filter__IgnoreDeleteFilter_0</span><span class="token operator">=</span><span class="token string">'?'</span> <span class="token punctuation">(</span>DbType <span class="token operator">=</span> <span class="token keyword">Boolean</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> CommandType<span class="token operator">=</span><span class="token string">'Text'</span><span class="token punctuation">,</span> CommandTimeout<span class="token operator">=</span><span class="token string">'30'</span><span class="token punctuation">]</span>
<span class="token keyword">SELECT</span> <span class="token punctuation">[</span>t<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>Id<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>t<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>IsDeleted<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>t<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>Name<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>t<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>TenantId<span class="token punctuation">]</span>
<span class="token keyword">FROM</span> <span class="token punctuation">[</span>TestTenant<span class="token punctuation">]</span> <span class="token keyword">AS</span> <span class="token punctuation">[</span>t<span class="token punctuation">]</span>
<span class="token keyword">WHERE</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token variable">@__ef_filter__IgnoreDeleteFilter_0</span> <span class="token operator">=</span> CAST<span class="token punctuation">(</span><span class="token number">1</span> <span class="token keyword">AS</span> <span class="token keyword">bit</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">OR</span> <span class="token punctuation">(</span><span class="token punctuation">[</span>t<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>IsDeleted<span class="token punctuation">]</span> <span class="token operator">=</span> CAST<span class="token punctuation">(</span><span class="token number">0</span> <span class="token keyword">AS</span> <span class="token keyword">bit</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">AND</span> <span class="token punctuation">(</span><span class="token punctuation">[</span>t<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>TenantId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span>
</code></pre></div><p>可以看到，原先的软删条件：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token punctuation">(</span><span class="token punctuation">[</span>t<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>IsDeleted<span class="token punctuation">]</span> <span class="token operator">=</span> CAST<span class="token punctuation">(</span><span class="token number">0</span> <span class="token keyword">AS</span> <span class="token keyword">bit</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>变成了：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token variable">@__ef_filter__IgnoreDeleteFilter_0</span> <span class="token operator">=</span> CAST<span class="token punctuation">(</span><span class="token number">1</span> <span class="token keyword">AS</span> <span class="token keyword">bit</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">OR</span> <span class="token punctuation">(</span><span class="token punctuation">[</span>t<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>IsDeleted<span class="token punctuation">]</span> <span class="token operator">=</span> CAST<span class="token punctuation">(</span><span class="token number">0</span> <span class="token keyword">AS</span> <span class="token keyword">bit</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>当 <code>IgnoreDeleteFilter</code> 为 true 时，将会禁用软件的筛选条件。</p> <p>查询的数据，也确实将软删的数据给查了出来。</p> <h2 id="_4-完整代码"><a href="#_4-完整代码" class="header-anchor">#</a> 4 完整代码</h2> <p>第3节中，完整的代码如下：</p> <h3 id="models"><a href="#models" class="header-anchor">#</a> Models</h3> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">namespace</span> <span class="token namespace">EFCoreTest<span class="token punctuation">.</span>Models</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">EntityBase</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">EntityBase<span class="token punctuation">&lt;</span>TKey<span class="token punctuation">&gt;</span></span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">EntityBase</span></span>
    <span class="token keyword">where</span> <span class="token class-name">TKey</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token keyword">struct</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">TKey</span> Id <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">interface</span> <span class="token class-name">ISoftDelete</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> IsDeleted <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestDelete</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">EntityBase<span class="token punctuation">&lt;</span><span class="token keyword">int</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name">ISoftDelete</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span><span class="token punctuation">?</span></span> Name <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> IsDeleted <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ITenant</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> TenantId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestTenant</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">EntityBase<span class="token punctuation">&lt;</span><span class="token keyword">int</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name">ITenant</span><span class="token punctuation">,</span> <span class="token class-name">ISoftDelete</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span><span class="token punctuation">?</span></span> Name <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> TenantId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> IsDeleted <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="edbcontext"><a href="#edbcontext" class="header-anchor">#</a> EDbContext</h3> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">using</span> <span class="token namespace">EFCoreTest<span class="token punctuation">.</span>Models</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>EntityFrameworkCore</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Linq<span class="token punctuation">.</span>Expressions</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Reflection</span><span class="token punctuation">;</span>

<span class="token keyword">namespace</span> <span class="token namespace">EFCoreTest</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EDbContext</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">DbContext</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> IgnoreDeleteFilter <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">EDbContext</span><span class="token punctuation">(</span><span class="token class-name">DbContextOptions<span class="token punctuation">&lt;</span>EDbContext<span class="token punctuation">&gt;</span></span> options<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">base</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token keyword">override</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnConfiguring</span><span class="token punctuation">(</span><span class="token class-name">DbContextOptionsBuilder</span> options<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">base</span><span class="token punctuation">.</span><span class="token function">OnConfiguring</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token keyword">override</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnModelCreating</span><span class="token punctuation">(</span><span class="token class-name">ModelBuilder</span> builder<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">//// 基本注册</span>
        <span class="token comment">//builder.Entity&lt;TestDelete&gt;().HasQueryFilter(e =&gt; !e.IsDeleted);</span>

        <span class="token class-name">Assembly</span> assembly <span class="token operator">=</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">EDbContext</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Assembly<span class="token punctuation">;</span>
        <span class="token comment">//Assembly assembly = Assembly.GetExecutingAssembly();</span>
        <span class="token class-name">List<span class="token punctuation">&lt;</span>Type<span class="token punctuation">&gt;</span></span> entityTypes <span class="token operator">=</span> assembly<span class="token punctuation">.</span><span class="token function">GetTypes</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span>t <span class="token operator">=&gt;</span> t<span class="token punctuation">.</span><span class="token function">IsSubclassOf</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">EntityBase</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>t<span class="token punctuation">.</span>IsAbstract<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">ToList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">MethodInfo<span class="token punctuation">?</span></span> configureFilters <span class="token operator">=</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">EDbContext</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetMethod</span><span class="token punctuation">(</span>
            <span class="token keyword">nameof</span><span class="token punctuation">(</span>ConfigureFilters<span class="token punctuation">)</span><span class="token punctuation">,</span>
            BindingFlags<span class="token punctuation">.</span>Instance <span class="token operator">|</span> BindingFlags<span class="token punctuation">.</span>NonPublic
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>configureFilters <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ArgumentNullException</span><span class="token punctuation">(</span><span class="token keyword">nameof</span><span class="token punctuation">(</span>configureFilters<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token class-name">Type</span> entityType <span class="token keyword">in</span> entityTypes<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token comment">// 注册实体</span>
            builder<span class="token punctuation">.</span><span class="token function">Entity</span><span class="token punctuation">(</span>entityType<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 注册筛选器</span>
            configureFilters
                <span class="token punctuation">.</span><span class="token function">MakeGenericMethod</span><span class="token punctuation">(</span>entityType<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">Invoke</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">object</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> <span class="token punctuation">{</span> builder<span class="token punctuation">,</span> entityType <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token keyword">virtual</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token generic-method"><span class="token function">ConfigureFilters</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TEntity<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">ModelBuilder</span> builder<span class="token punctuation">,</span> <span class="token class-name">Type</span> entityType<span class="token punctuation">)</span>
            <span class="token keyword">where</span> <span class="token class-name">TEntity</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token keyword">class</span></span>
    <span class="token punctuation">{</span>
        <span class="token class-name">Expression<span class="token punctuation">&lt;</span>Func<span class="token punctuation">&lt;</span>TEntity<span class="token punctuation">,</span> <span class="token keyword">bool</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span><span class="token punctuation">?</span></span> expression <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">ISoftDelete</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">IsAssignableFrom</span><span class="token punctuation">(</span>entityType<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            expression <span class="token operator">=</span> e <span class="token operator">=&gt;</span> IgnoreDeleteFilter <span class="token operator">||</span> <span class="token operator">!</span>EF<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Property</span><span class="token generic class-name"><span class="token punctuation">&lt;</span><span class="token keyword">bool</span><span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> <span class="token string">&quot;IsDeleted&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">ITenant</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">IsAssignableFrom</span><span class="token punctuation">(</span>entityType<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token class-name">Expression<span class="token punctuation">&lt;</span>Func<span class="token punctuation">&lt;</span>TEntity<span class="token punctuation">,</span> <span class="token keyword">bool</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> tenantExpression <span class="token operator">=</span> e <span class="token operator">=&gt;</span> EF<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Property</span><span class="token generic class-name"><span class="token punctuation">&lt;</span><span class="token keyword">int</span><span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> <span class="token string">&quot;TenantId&quot;</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">;</span>
            expression <span class="token operator">=</span> expression <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token punctuation">?</span> tenantExpression <span class="token punctuation">:</span> <span class="token function">CombineExpressions</span><span class="token punctuation">(</span>expression<span class="token punctuation">,</span> tenantExpression<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>expression <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

        builder<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Entity</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TEntity<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">HasQueryFilter</span><span class="token punctuation">(</span>expression<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token keyword">virtual</span> <span class="token return-type class-name">Expression<span class="token punctuation">&lt;</span>Func<span class="token punctuation">&lt;</span>T<span class="token punctuation">,</span> <span class="token keyword">bool</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">CombineExpressions</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">Expression<span class="token punctuation">&lt;</span>Func<span class="token punctuation">&lt;</span>T<span class="token punctuation">,</span> <span class="token keyword">bool</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> expression1<span class="token punctuation">,</span> <span class="token class-name">Expression<span class="token punctuation">&lt;</span>Func<span class="token punctuation">&lt;</span>T<span class="token punctuation">,</span> <span class="token keyword">bool</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> expression2<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name"><span class="token keyword">var</span></span> parameter <span class="token operator">=</span> Expression<span class="token punctuation">.</span><span class="token function">Parameter</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">T</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name"><span class="token keyword">var</span></span> leftVisitor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ReplaceExpressionVisitor</span><span class="token punctuation">(</span>expression1<span class="token punctuation">.</span>Parameters<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> parameter<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> left <span class="token operator">=</span> leftVisitor<span class="token punctuation">.</span><span class="token function">Visit</span><span class="token punctuation">(</span>expression1<span class="token punctuation">.</span>Body<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name"><span class="token keyword">var</span></span> rightVisitor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ReplaceExpressionVisitor</span><span class="token punctuation">(</span>expression2<span class="token punctuation">.</span>Parameters<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> parameter<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> right <span class="token operator">=</span> rightVisitor<span class="token punctuation">.</span><span class="token function">Visit</span><span class="token punctuation">(</span>expression2<span class="token punctuation">.</span>Body<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> Expression<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Lambda</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Func<span class="token punctuation">&lt;</span>T<span class="token punctuation">,</span> <span class="token keyword">bool</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>Expression<span class="token punctuation">.</span><span class="token function">AndAlso</span><span class="token punctuation">(</span>left<span class="token punctuation">,</span> right<span class="token punctuation">)</span><span class="token punctuation">,</span> parameter<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">class</span> <span class="token class-name">ReplaceExpressionVisitor</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">ExpressionVisitor</span></span>
    <span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">Expression</span> _oldValue<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">Expression</span> _newValue<span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token function">ReplaceExpressionVisitor</span><span class="token punctuation">(</span><span class="token class-name">Expression</span> oldValue<span class="token punctuation">,</span> <span class="token class-name">Expression</span> newValue<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            _oldValue <span class="token operator">=</span> oldValue<span class="token punctuation">;</span>
            _newValue <span class="token operator">=</span> newValue<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token return-type class-name">Expression</span> <span class="token function">Visit</span><span class="token punctuation">(</span><span class="token class-name">Expression<span class="token punctuation">?</span></span> node<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token operator">==</span> _oldValue<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">return</span> _newValue<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">return</span> <span class="token keyword">base</span><span class="token punctuation">.</span><span class="token function">Visit</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token operator">!</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="测试-controller"><a href="#测试-controller" class="header-anchor">#</a> 测试 Controller</h3> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">using</span> <span class="token namespace">EFCoreTest</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">EFCoreTest<span class="token punctuation">.</span>Models</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>AspNetCore<span class="token punctuation">.</span>Mvc</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>EntityFrameworkCore</span><span class="token punctuation">;</span>

<span class="token keyword">namespace</span> <span class="token namespace">QueryFilterTest<span class="token punctuation">.</span>Controllers</span><span class="token punctuation">;</span>

<span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">ApiController</span></span><span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Route</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">&quot;[controller]/[action]&quot;</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestController</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">ControllerBase</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">EDbContext</span> _context<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">ILogger<span class="token punctuation">&lt;</span>TestController<span class="token punctuation">&gt;</span></span> _logger<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">TestController</span><span class="token punctuation">(</span><span class="token class-name">ILogger<span class="token punctuation">&lt;</span>TestController<span class="token punctuation">&gt;</span></span> logger<span class="token punctuation">,</span> <span class="token class-name">EDbContext</span> context<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _logger <span class="token operator">=</span> logger<span class="token punctuation">;</span>
        _context <span class="token operator">=</span> context<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">HttpGet</span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">List<span class="token punctuation">&lt;</span>TestDelete<span class="token punctuation">&gt;</span></span> <span class="token function">GetDeleteBase</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// 过滤 IsDeleted == true 的数据</span>
        <span class="token class-name"><span class="token keyword">var</span></span> deletes <span class="token operator">=</span> _context<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Set</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TestDelete<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 忽略筛选器，不过滤数据</span>
        <span class="token class-name"><span class="token keyword">var</span></span> allDeletes <span class="token operator">=</span> _context<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Set</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TestDelete<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">IgnoreQueryFilters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> allDeletes<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">HttpGet</span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">List<span class="token punctuation">&lt;</span>TestTenant<span class="token punctuation">&gt;</span></span> <span class="token function">GetTenant</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// 软删、多租户 筛选器同时作用</span>
        <span class="token class-name"><span class="token keyword">var</span></span> tenants <span class="token operator">=</span> _context<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Set</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TestTenant<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 禁用所有的筛选器</span>
        <span class="token class-name"><span class="token keyword">var</span></span> allTenants <span class="token operator">=</span> _context<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Set</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TestTenant<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">IgnoreQueryFilters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> allTenants<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">HttpGet</span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">List<span class="token punctuation">&lt;</span>TestTenant<span class="token punctuation">&gt;</span></span> <span class="token function">GetTenantIgnoreDelete</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// 禁用软件筛选器</span>
        _context<span class="token punctuation">.</span>IgnoreDeleteFilter <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> tenants <span class="token operator">=</span> _context<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Set</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TestTenant<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> tenants<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="完整项目代码"><a href="#完整项目代码" class="header-anchor">#</a> 完整项目代码：</h3> <p>Gitee：https://gitee.com/lisheng741/testnetcore/tree/master/EFCore/QueryFilterTest</p> <p>Github：https://github.com/lisheng741/testnetcore/tree/master/EFCore/QueryFilterTest</p> <h2 id="参考来源"><a href="#参考来源" class="header-anchor">#</a> 参考来源</h2> <p>ABP 源码</p> <p><a href="https://docs.microsoft.com/zh-cn/ef/core/querying/filters" target="_blank" rel="noopener noreferrer">EF Core 官方文档：全局查询筛选器<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://www.cnblogs.com/CreateMyself/p/8491058.html" target="_blank" rel="noopener noreferrer">EntityFramework Core 2.0全局过滤（HasQueryFilter）<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/lisheng741/blog/edit/master/docs/backend/EFCore数据过滤.md" target="_blank" rel="noopener noreferrer">在 GitHub 上编辑此页</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2022/7/24 21:37:22</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/backend/EFCore概述.html" class="prev">
        EF Core 概述
      </a></span> <span class="next"><a href="/blog/backend/EFCore关联查询.html">
        EF Core 的关联查询
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/blog/assets/js/app.558beeb7.js" defer></script><script src="/blog/assets/js/2.c9b070a5.js" defer></script><script src="/blog/assets/js/25.69362e2a.js" defer></script>
  </body>
</html>
