# 中间件

官方文档：https://docs.microsoft.com/zh-cn/aspnet/core/fundamentals/middleware/?view=aspnetcore-6.0



## 基本方法

Use：

Map：分支节点

Run：终结点

### Use

```c#
//写法1
app.Use(async(context, next) => 
{
    await next.Invoke();
});
//写法2
app.Use(MiddleHandler);
static async Task MiddleHandler(HttpContext context, RequestDelegate next)
{
    await next.Invoke(context);
}
```

### Run

```c#
app.Run(async context => 
{
    await context.Response.WriteAsync("run");
});
```

### Map

```c#
app.Map("/map", app => 
{
    app.Run(async context => 
    {
        await context.Response.WriteAsync("map run");
    });
});
//Map 嵌套
app.Map("/map", app => {
    app.Map("/1", app1 => {
        
    });
    app.Map("/2", app2 => {
        
    });
});
//MapWhen 
app.MapWhen(
    context => context.Request.Query.ContainsKey("test"),
    MapWhenHandle
);
static void MapWhenHandle(IApplicationBuilder app)
{
    app.Run(async context => {
        await context.Response.WriteAsync("Map when");
    });
}
```



## 自定义中间件

```c#
//自定义中间件
public class CustomMiddleware
{
    private readonly RequestDelegate _next;
    
    public CustomMiddleware(RequestDelegate next)
    {
        _next = next;
    }
    
    public async Task Invoke(HttpContext context)
    {
        await _next.Invoke(context);
    }
    //Invoke 方法的其他参数，可以通过 DI 注入
    //public async Task Invoke(HttpContext context, ITest test)
}
//扩展方法
public static class CustomMiddlewareExtensions
{
    public static IApplicationBuilder UseCustom(this IApplicationBuilder app)
    {
        return app.UseMiddleware<CustomMiddleware>();
    }
}
```



## 中间件顺序

异常，重定向，静态文件，路由，跨域，身份验证（Authentication），授权（Authorization），Session，终结点

```c#
if (env.IsDevelopment())
{
    app.UseDeveloperExceptionPage();
    app.UseDatabaseErrorPage();
}
else
{
    app.UseExceptionHandler("/Error");
    app.UseHsts();
}
app.UseHttpsRedirection();
app.UseStaticFiles();
app.UseCookiePolicy();
app.UseRouting();
app.UseAuthentication();
app.UseAuthorization();
app.UseSession();
app.MapRazorPages();
```



## 内置中间件



